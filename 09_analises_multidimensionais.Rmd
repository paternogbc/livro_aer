# An√°lises Multidimensionais {#cap9}

## Pr√©-requisitos do cap√≠tulo {-}

Pacotes e dados que ser√£o utilizados neste cap√≠tulo.

```{r message=FALSE, warning=FALSE}
## Pacotes 
library(ade4)
library(ecodados)
library(tidyverse)
library(vegan) 
library(pvclust)
library(BiodiversityR)
library(labdsv)
library(ggplot2)
library(gridExtra)
library(ape)
library(FactoMineR)
library(factoextra)
library(FD)
library(palmerpenguins)
library(GGally)
library(fields)
library(ade4)
library(ggord)
library(udunits2)
library(adespatial)
library(spdep)
library(mvabund)
library(reshape)

## Dados
sp_compos        <- ecodados::bocaina
species          <- ecodados::com_birds
env              <- ecodados::env_birds
xy               <- ecodados::birds.xy
bocaina.env      <- ecodados::bocaina.env
bocaina.xy       <- ecodados::bocaina.xy
anuros_permanova <- ecodados::anuros_permanova
macroinv         <- ecodados::macroinv
fish_comm        <- ecodados::fish_comm
data(mite)
data(doubs)
data(mite.env)

## Traduzir nomes para portugu√™s 
colnames(penguins) <- c("especies", "ilha", "comprimento_bico", "profundidade_bico", "comprimento_nadadeira", "massa_corporal", "sexo", "ano")

```

## Aspectos te√≥ricos

An√°lises multivariadas avaliam hip√≥teses cuja vari√°vel resposta √© definida por m√∫ltiplas vari√°veis ao mesmo tempo, comumente expressa na forma de uma matriz quadrada ou de dist√¢ncia (dissimilaridade).

Em geral, an√°lises multivariadas t√™m tr√™s principais utilidades: i) reduzir a dimensionalidade dos dados e encontrar a principal dire√ß√£o de varia√ß√£o dos mesmos, ii) testar rela√ß√µes entre matrizes, ou ainda, iii) encontrar diferen√ßas entre grupos. An√°lises multivariadas podem ser utilizadas como an√°lises explorat√≥rias e/ou para descrever padr√µes em estudos ecol√≥gicos. No entanto, mesmo quando se deseja apenas explorar o conjunto de dados para encontrar poss√≠veis padr√µes, a necessidade de se ter hip√≥teses, ou ao menos expectativas *a priori*, n√£o pode ser ignorada. Antes de entrar de cabe√ßa nas an√°lises multivariadas, tamb√©m sugerimos fortemente o estudo de m√©todos de amostragem e como fazer boas perguntas (Cap√≠tulo \@ref(cap2)).

An√°lises multivariadas podem ser divididas, grosseiramente, em dois tipos: agrupamento e ordena√ß√£o. An√°lises de agrupamento, em geral, tentam agrupar objetos (observa√ß√µes) ou descritores em grupos de maneira que objetos do mesmo grupo sejam mais semelhantes entre si do que objetos de outros grupos [@legendre_numerical_2012]. Por exemplo, os objetos podem ser localidades como "parcelas", "riachos" ou "florestas", enquanto os descritores s√£o as difentes vari√°veis coletadas para esses objetos (e.g., esp√©cies, vari√°veis ambientais). A an√°lise de ordena√ß√£o, por sua vez, √© uma opera√ß√£o pela qual os objetos (ou descritores) s√£o posicionados num espa√ßo que cont√©m menos dimens√µes que o conjunto de dados original; a posi√ß√£o dos objetos ou descritores em rela√ß√£o aos outros tamb√©m pode ser usada para agrup√°-los.

### Coeficientes de associa√ß√£o

Assim chamados genericamente, os coeficientes de associa√ß√£o medem o qu√£o parecidos objetos ou descritores s√£o entre si. Objetos est√£o nas linhas da matriz, enquanto descritores est√£o nas colunas. Geralmente objetos s√£o as nossas unidades amostrais, enquanto os descritores s√£o as vari√°veis. Quando analisamos a rela√ß√£o entre objetos fazemos uma an√°lise no modo Q, ao passo que o modo R √© quando analisamos a rela√ß√£o entre descritores. Coeficientes de associa√ß√£o do modo Q s√£o medidas de (dis)similaridade ou dist√¢ncia, enquanto para o modo R utilizamos covari√¢ncia ou correla√ß√£o. Como j√° tratamos neste livro sobre covari√¢ncia e correla√ß√£o (ver Cap√≠tulo \@ref(cap7)), neste t√≥pico vamos falar sobre √≠ndices de dist√¢ncia e similaridade. Mas qual a defini√ß√£o destas duas quantitades?

- Similaridade s√£o m√°ximas (*S=1*) quando dois objetos s√£o id√™nticos
- Dist√¢ncias s√£o o contr√°rio da similaridade (*D=1-S*) e n√£o t√™m limites superiores (dependem da unidade de medida)

Existem ao menos 26 √≠ndices de similaridade que podem ser agrupados de acordo com o tipo de dado (qualitativos ou quantitativos) ou a maneira com que lidam com duplos zeros (sim√©tricos ou assim√©tricos) [@legendre_numerical_2012]. Do seu lado, as dist√¢ncias s√≥ se aplicam a dados quantitativos e t√™m como caracter√≠sticas serem m√©tricas, semi-m√©tricas ou n√£o-m√©tricas. Vejamos agora os principais √≠ndices de similaridade e dist√¢ncia de cada tipo.

### M√©tricas de dist√¢ncia

O principal coeficiente de dist√¢ncia usado em ecologia √© a dist√¢ncia euclidiana. Al√©m disso, temos ainda Canberra (varia√ß√£o da Dist√¢ncia Euclidiana), Mahalanobis (calcula a dist√¢ncia entre dois pontos num espa√ßo n√£o ortogonal, levando em considera√ß√£o a covari√¢ncia entre descritores), Manhattan (varia√ß√£o da Dist√¢ncia Euclidiana), Chord (elimina diferen√ßas entre abund√¢ncia total de esp√©cies), ùúí2 (d√° peso maior para esp√©cies raras), Hellinger (n√£o d√° peso para esp√©cies raras). Essas dist√¢ncias s√£o recomendadas nos casos em que as vari√°veis de estudo forem cont√≠nuas, como por exemplo, **vari√°veis morfom√©tricas ou descritores ambientais**.

Uma caracter√≠stica comum de conjuntos de dados ecol√≥gicos s√£o os v√°rios zeros encontrados em matrizes de composi√ß√£o. Eles surgem porque n√£o encontramos nenhum indiv√≠duo de uma determinada esp√©cie num local, seja porque aquele local n√£o tem as condi√ß√µes ambientais adequadas a ela, falha na detectabilidade, ou din√¢micas demogr√°ficas estoc√°sticas de coloniza√ß√£o-extin√ß√£o [@blascomoreno2019]. Logo, quando dois locais compartilham aus√™ncia de esp√©cies, n√£o √© poss√≠vel atribuir uma √∫nica raz√£o da dupla aus√™ncia. Como essas medidas de dist√¢ncia apresentadas acima assumem que os dados s√£o quantitativos e n√£o de contagem, elas n√£o s√£o adequadas para lidar com dados de abund√¢ncia ou incid√™ncia de esp√©cies, porque atribuem um grau de parec√™n√ßa a pares de locais que compartilham zeros [@legendre_numerical_2012]. Por esse motivo, precisamos de coeficientes que desconsiderem os duplos zeros. Eles s√£o chamados de *assim√©tricos*.

**Coeficientes assim√©tricos bin√°rios para objetos**

Esses coeficientes (ou √≠ndices) s√£o apropriados para dados de incid√™ncia de esp√©cies (presen√ßa-aus√™ncia) e desconsideram as duplas aus√™ncias. Os √≠ndices deste tipo mais comuns utilizados em ecologia s√£o Jaccard, S√∏rensen e Ochiai.

O coeficiente de Jaccard √© dado por: 

$$\beta_j = a/(a+b+c)$$
onde 

- *a* = n√∫mero de esp√©cies compartilhadas
- *b* = n√∫mero de esp√©cies exclusivas da comunidade 1
- *c* = n√∫mero de esp√©cies exclusivas da comunidade 2

A diferen√ßa entre os √≠ndices de Jaccard e S√∏rensen √© que o √≠ndice de S√∏rensen d√° peso dobrado para duplas presen√ßas. Por conta dessas caracter√≠sticas, estes √≠ndices s√£o adequados para quantificar diversidade beta [@anderson2010; @legendre2013]. Esses √≠ndices variam entre 0 (nenhuma esp√©cie √© compartilhada entre o par de locais) a 1 (todas as esp√©cies s√£o compartilhadas entre o par de locais).

O coeficiente de S√∏rensen √© dado por: 

$$\beta_s = 2a/(2a+b+c)$$
onde 

- *a* = n√∫mero de esp√©cies compartilhadas
- *b* = n√∫mero de esp√©cies exclusivas da comunidade 1
- *c* = n√∫mero de esp√©cies exclusivas da comunidade 2

**Coeficientes bin√°rios para descritores (R mode)**

Se o objetivo for calcular a similaridade entre descritores bin√°rios (e.g., presen√ßa ou aus√™ncia de caracter√≠sticas ambientais) de pares de locais, geralmente o coeficiente recomendado √© o de Sokal & Michener. Este √≠ndice est√° implementado na fun√ß√£o `dist.binary()` do pacote `ade4`.

**Coeficientes quantitativos para objetos**

Estes s√£o os coeficientes utilizados para dados de contagem (e.g., abund√¢ncia) e quantitativos (e.g., frequ√™ncia, biomassa, porcentagem de cobertura). Diferentemente das dist√¢ncias, estes coeficientes s√£o assim√©tricos, ou seja, n√£o consideram duplas aus√™ncias, e portanto, s√£o adequados para analisar dados de composi√ß√£o de esp√©cies. Al√©m disso, uma outra caracter√≠stica deles √© serem semi-m√©tricos. Os √≠ndices mais comuns deste tipo s√£o Bray-Curtis (conhecido como *percentage difference*, em ingl√™s), Chord, log-Chord, Hellinger, chi-quadrado e Morisita-Horn.

Todos os √≠ndices discutidos at√© aqui est√£o implementados nas fun√ß√µes `ade4::dist.ktab()`, `adespatial::dist.ldc()` e `vegan::vegdist()`.

**Coeficientes para descritores (R mode) que incluem mistura de tipos de dados**

√â comum em an√°lises de diversidade funcional que tenhamos um conjunto de atributos (*traits*) de esp√©cies que s√£o formados por v√°rios tipos de dados: quantitativos (e.g., tamanho de corpo), bin√°rios (presen√ßa/aus√™ncia de uma dada caracter√≠stica), *fuzzy* (um atributo multiestado codificado em v√°rias colunas), ordinais e circulares (e.g., distribui√ß√£o de uma fenofase ao longo de um ano). O √≠ndice que lida com todos esses dados √© o Gower. A vers√£o extendida do √≠ndice de Gower pode ser encontrada na fun√ß√£o `ade4::dist.ktab().`

O cap√≠tulo 7 de Legendre & Legendre [-@legendre_numerical_2012] fornece uma chave dicot√¥mica para escolha do √≠ndice mais adequado.

**Padroniza√ß√µes e transforma√ß√µes**

√â comum coletarmos m√∫ltiplas vari√°veis ambientais cujas unidades sejam diferentes. Por exemplo, temperatura (¬∫C), dist√¢ncia da margem (m), √°rea (m^2^), etc. Para diminuir a taxa de Erro do Tipo I das an√°lises (rejeitar a hip√≥tese nula quando ela √© verdadeira), √© recomendado que ***padronizemos*** os dados utilizando distribui√ß√£o *Z*, assim todas as vari√°veis passam a ter m√©dia 0 e desvio padr√£o 1. Essa opera√ß√£o garante que todas as vari√°veis tenham o mesmo peso nas an√°lises que avaliam o padr√£o dos objetos considerando os m√∫ltiplos descritores. Essa padroniza√ß√£o pode ser implementada na fun√ß√£o `vegan::decostand()`.

Outro problema comum de matrizes de dados de composi√ß√£o de esp√©cies √© o alto n√∫mero de zeros, enquanto outras esp√©cies podem ter altas abund√¢ncias. Isso gera problemas em ordena√ß√µes. Para diminuir essa discrep√¢ncia, podemos **transformar** os dados, por exemplo, utilizando a dist√¢ncia de Hellinger ou Chord. Para dados cont√≠nuos pode ser que transforma√ß√£o log ou raiz quadrada ajude quando h√° valores muito discrepantes (*leverages*) que podem influenciar em demasiado a rela√ß√£o entre objetos ou descritores. Isso pode ser feito na fun√ß√£o `vegan::decostand()`.

## An√°lises de agrupamento

O objetivo da an√°lise de agrupamento √© agrupar objetos admitindo que haja um grau de similaridade entre eles. Esta an√°lise pode ser utilizada ainda para classificar uma popula√ß√£o em grupos homog√™neos de acordo com uma caracter√≠stica de interesse. A grosso modo, uma an√°lise de agrupamento tenta resumir uma grande quantidade de dados e apresent√°-la de maneira f√°cil de visualizar e entender (em geral, na forma de um dendrograma). No entanto, os resultados da an√°lise podem n√£o refletir necessariamente toda a informa√ß√£o originalmente contida na matriz de dados. Para avaliar o qu√£o bem uma an√°lise de agrupamento representa os dados originais existe uma m√©trica --- o coeficiente de correla√ß√£o cofen√©tico --- o qual discutiremos em detalhes mais adiante.

Antes de considerar algum m√©todo de agrupamento, pense porque voc√™ esperaria que houvesse uma descontinuidade nos dados; ou ainda, considere se existe algum ganho pr√°tico em dividir uma nuvem de objetos cont√≠nuos em grupos. O padr√£o apresentado pelo dendograma depende do protocolo utilizado (m√©todo de agrupamento e √≠ndice de dissimilaridade); os grupos formados dependem do n√≠vel de corte escolhido.

A matriz deve conter os objetos a serem agrupados (e.g., esp√©cies) nas linhas e as vari√°veis (e.g., locais de coleta ou medidas morfol√≥gicas) nas colunas. A escolha do m√©todo de agrupamento √© cr√≠tico para a escolha de um coeficiente de associa√ß√£o. √â importante compreender as propriedades dos m√©todos de agrupamento para interpretar corretamente a estrutura ecol√≥gica que eles evidenciam [@legendre_numerical_2012]. De acordo com a classifica√ß√£o de Sneath & Sokal [-@sneath_numerical_1973], existem cinco tipos de m√©todos: i) sequenciais ou simult√¢neos, ii) aglomerativo ou divisivo, iii) monot√©ticos ou polit√©ticos, iv) hier√°rquico ou n√£o hier√°rquicos e v) probabil√≠stico. Sugerimos a leitura do artigo citado anteriormente para aprofundar seus conhecimentos sobre os diferentes m√©todos.

### Agrupamento hier√°rquico

M√©todos hier√°rquicos podem ser divididos naqueles que consideram o centr√≥ide ou a m√©dia aritm√©tica entre os grupos. O principal m√©todo hier√°rquico que utiliza a m√©dia aritm√©tica √© o UPGMA (Agrupamento pelas m√©dias aritm√©ticas n√£o ponderadas), e o principal m√©todo que utiliza centr√≥ides √© a Dist√¢ncia m√≠nima de Ward.

O UPGMA funciona da seguinte forma: a maior similaridade (ou menor dist√¢ncia) identifica os pr√≥ximos agrupamentos a serem formados. Ap√≥s esse evento, o m√©todo calcula a m√©dia aritm√©tica das similaridades ou dist√¢ncias entre um objeto e cada um dos membros do grupo ou, no caso de um grupo previamente formado, entre todos os membros dos dois grupos. Todos os objetos recebem pesos iguais no c√°lculo.

O m√©todo de Ward √© baseado no crit√©rio de quadrados m√≠nimos (OLS), o mesmo utilizado para ajustar um modelo linear (Cap√≠tulo \@ref(cap7)). O objetivo √© definir os grupos de maneira que a soma de quadrados (i.e. similar ao erro quadrado da ANOVA) dentro dos grupos seja minimizada [@borcard2018].

No entanto, para interpretar os resultados precisamos antes definir um n√≠vel de corte, que vai nos dizer quantos grupos existem. H√° v√°rios m√©todos para definir grupos, desde os heur√≠sticos aos que utilizam reamostragem (*bootstrap*). Se quisermos interpretar este dendrograma, podemos, por exemplo, estabelecer um n√≠vel de corte de 50% de dist√¢ncia (ou seja, grupos cujos objetos tenham ao menos 50% de similaridade entre si).

**Checklist**

- Verifique se n√£o h√° espa√ßo nos nomes das colunas e linhas

- Se os dados forem de abund√¢ncia, recomenda-se realizar a transforma√ß√£o de Hellinger [@legendre2001]. Esta transforma√ß√£o √© necess√°ria porque a matriz de comunidades (em especial, com a presen√ßa de muitas esp√©cies raras) pode causar distor√ß√µes nos m√©todos de ordena√ß√£o baseados em dist√¢ncia Euclidiana [@legendre2001]  

-   Se a matriz original contiver muitos valores discrepantes (e.g., uma esp√©cie muito mais ou muito menos abundante que outras) √© necess√°rio transformar os dados usando `log1p()`. No entanto, deve-se fazer ou a transforma√ß√£o de Hellinger ou log e nunca as duas ao mesmo tempo

-   Se as vari√°veis forem medidas tomadas em diferentes escalas (metros, graus celsius etc.), √© necess√°rio padronizar cada vari√°vel para ter a m√©dia 0 e desvio padr√£o 1. Isso pode ser feito utulizando a fun√ß√£o `decostand()` do pacote `vegan`

**Exemplo 1**

Neste exemplo, vamos utilizar um conjunto de dados que cont√©m girinos de esp√©cies de anuros coletados em 14 po√ßas com diferentes coberturas de dossel [@provete_broad-scale_2014].

**Pergunta**

-   Existem grupos de esp√©cies de anf√≠bios anuros com padr√µes de ocorr√™ncia similar ao longo das po√ßas?

**Predi√ß√µes**

-   Iremos encontrar ao menos dois grupos de esp√©cies: aquelas que ocorrem em po√ßas dentro de floresta (i.e., maior cobertura de dossel) *vesus* aquelas que ocorrem em po√ßas de √°reas abertas (menor cobertura de dossel)

**Vari√°veis**

-   Vari√°veis preditoras: a matriz de dados cont√©m a abund√¢ncia das esp√©cies nas linhas e locais (po√ßas) nas colunas

**An√°lises**

Para come√ßar, vamos primeiro importar os dados e depois calcular a matriz de dist√¢ncia que seja adequada para o tipo de dado que temos (abund√¢ncia de esp√©cies - dados de contagem) (Figura \@ref(fig:fig-dend)).

```{r fig-dend, fig.cap="Dendrograma mostrando uma an√°lise de agrupamento de anuros.", message=FALSE, warning=FALSE}
## Composi√ß√£o de esp√©cies (seis primeiras localidades)
head(sp_compos)

## Matriz de similaridade com o coeficiente de Morisita-Horn
distBocaina <- vegdist(x = sp_compos, method = "horn")

## Agrupamento com a fun√ß√£o hclust e o m√©todo UPGMA
dendro <- hclust(d = distBocaina, method = "average")

## Visualizar os resultados
plot(dendro, main = "Dendrograma", 
     ylab = "Similaridade (√≠ndice de Horn)",
     xlab="", sub="")
```

**Assessando a qualidade do dendrograma**

Precisamos verificar se o agrupamento reduziu a dimensionalidade da matiz de forma eficiente, de maneira a n√£o distorcer a informa√ß√£o. Fazemos isso calculando o **Coeficiente de Correla√ß√£o Cofen√©tica**.

```{r}
## Coeficiente de correla√ß√£o cofen√©tica
cofresult <- cophenetic(dendro)
cor(cofresult, distBocaina)
```

Um coeficiente de correla√ß√£o cofen√©tica \> .7 indica uma boa representa√ß√£o. Portanto, o nosso resultado de `r cor(cofresult, distBocaina)` √© alto, garantindo que o dendrograma √© adequado (Figura \@ref(fig:fig-dend-group)). Note que testar a "signific√¢ncia" deste coeficiente n√£o √© adequado, j√° que seria algo tautol√≥gico (circular). Claro que definir o que seria um valor "alto" ou "baixo" da correla√ß√£o √© um pouco arbritr√°rio, mas pode-se usar como "regra do polegar".

```{r fig-dend-group, fig.cap="Dendrograma mostrando uma an√°lise de agrupamento de anuros com uma linha de corte formando cinco grupos.", message=FALSE, warning=FALSE}
## Gr√°fico
plot(dendro, main = "Dendrograma", 
     ylab = "Similaridade (√≠ndice de Horn)",
     xlab="", sub="")
k <- 4
n <- ncol(sp_compos)
MidPoint <- (dendro$height[n-k] + dendro$height[n-k+1]) / 2
abline(h = MidPoint, lty=2)
```

Nesse caso teremos a forma√ß√£o de cinco grupos, representados pelos n√≥s que est√£o abaixo da linha de corte. Portanto, o resultado n√£o suporta a nossa hip√≥tese *a priori* que predizia a forma√ß√£o de apenas dois grupos de esp√©cies.

**Exemplo 2**

No exemplo anterior, vimos que √© dif√≠cil interpretar os grupos baseado num n√≠vel de corte. A seguir, vamos utilizar o pacote `pvclust` que . Uma desvantagem deste m√©todo √© que ele somente aceita √≠ndices de similaridade da fun√ß√£o `dist()`, que possui apenas a dist√¢ncia Euclidiana, Manhattan e Canberra. Uma maneira de contornarmos essa limita√ß√£o √© utilizar transforma√ß√µes dos dados dispon√≠veis na fun√ß√£o `disttransform()` no pacote `BiodiversityR` ou a fun√ß√£o `decostand()` do pacote `vegan`. Tamb√©m √© poss√≠vel utilizar a transforma√ß√£o de Box-Cox para dados multivariados, dispon√≠vel no [material suplementar](http://www.ecography.org/appendix/ecog-03498) de Legendre & Borcard [-@legendre2018]. Esta transforma√ß√£o √© geralmente utilizada para tornar a distribui√ß√£o dos dados mais sim√©trica (menos enviesada para valores extremos: reduzir o *skewness* dos dados).

**An√°lises**

Vamos utilizar o mesmo conjunto de dados do Exemplo 1 para responder √† mesma pergunta. Aqui vamos utilizar a dist√¢ncia de Chord (que √© indicada para dados de composi√ß√£o de esp√©cies) para calcular a matriz de dist√¢ncia. Se transformarmos uma matriz usando a transforma√ß√£o Chord e depois calcularmos a dist√¢ncia Euclidiana, isso equivale √† calcular diretamente a dist√¢ncia de Chord (Figura \@ref(fig:fig-dend-boot-chor)).

```{r fig-dend-boot-chor, fig.cap="Dendrograma mostrando uma an√°lise de agrupamento de anuros com uma linha de corte criada por bootstrap e usando dist√¢ncia de Chord.", message=FALSE, warning=FALSE}
## Dados
head(t(sp_compos))

## Passo 1: transformar para dist√¢ncia de Chord
bocaina_transf <- disttransform(t(sp_compos), "chord")

## Passo 2: realizar pvclust com m√©todo average e dist√¢ncia euclidiana
analise <- pvclust(bocaina_transf, method.hclust = "average", method.dist = "euclidean", quiet = TRUE) 
## Passo 3: dendrograma
plot(analise, hang=-1, main = "Dendrograma com valores de P", 
     ylab = "Dist√¢ncia Euclideana",
     xlab="", sub="")
pvrect(analise)
```

√â poss√≠vel notar que existe um √∫nico grupo com BS \> 95%. Agora vamos tentar usar a dist√¢ncia de Hellinger, que √© recomendada (junto com a dist√¢ncia de Chord) para transformar dados de composi√ß√£o de esp√©cies [@legendre2001] (Figura \@ref(fig:fig-dend-boot-hell)).

```{r fig-dend-boot-hell, fig.cap="Dendrograma mostrando uma an√°lise de agrupamento de anuros com uma linha de corte criada por bootstrap e usando dist√¢ncia de Hellinger.", message=FALSE, warning=FALSE}
## Passo 1: transformar dados com Hellinger
bocaina_transf2 <- disttransform(t(bocaina), "hellinger")

## Passo 2: realizar pvclust com m√©todo average e dist√¢ncia euclidiana
analise2 <- pvclust(bocaina_transf2, method.hclust="average", method.dist="euclidean", quiet = TRUE) 

## Passo 3: dendrograma
plot(analise2, hang=-1, main = "Dendrograma com valores de P", 
     ylab = "Dist√¢ncia Euclideana",
     xlab="", sub="")
k <- 4
n <- ncol(sp_compos)
MidPoint <- (dendro$height[n-k] + dendro$height[n-k+1]) / 2
abline(h = MidPoint, lty=2)
pvrect(analise2)
```

**Interpreta√ß√£o dos resultados**

Notem que se mudarmos o coeficiente de associa√ß√£o, o resultado tamb√©m muda. Agora temos um grupo a mais, composto por *Dendropsophus minutus* e *Scinax duartei* que n√£o apareciam antes. Isso se deve ao fato de que a dist√¢ncia de Hellinger d√° menos peso para esp√©cies raras do que a Chord.

Neste sentido, os dados n√£o suportam a nossa hip√≥tese inicial da forma√ß√£o de dois grupos, independentemente do coeficiente de associa√ß√£o utilizado e do c√°lculo automatico do n√≠vel de corte baseado na reamostragem.

### Agrupamento n√£o-hier√°rquico (*K-means*)

Ao contr√°rio do dendrograma, o K-means √© um agrupamento n√£o-hier√°rquico e, desse modo, n√£o √© otimizado para busca grupos menores aninhados em grupos maiores. Resumidamente, podemos calcular o K-means a partir de uma matriz quadrada ou de dist√¢ncia. Essa t√©cnica procura particionar os objetos em *k* grupos de maneira a minimizar a soma de quadrados entre grupos e maximiz√°-la dentro dos grupos. Um crit√©rio similar ao de uma ANOVA (Cap√≠tulo \@ref(cap7)). Um diferencial do K-means em rela√ß√£o aos agrupamentos hier√°rquicos √© que o usu√°rio pode escolher antecipadamente o n√∫mero de grupos que deseja formar.

**Exemplo 1**

Para este exemplo, iremos utilizar um conjunto de dados dispon√≠vel no pacote `ade4` que cont√©m dados de 27 esp√©cies de peixes coletados em 30 pontos ao longo do Rio Doubs, na fronteira entre a Fran√ßa e Su√≠√ßa.

**Pergunta**

-   Qual √© o n√∫mero de grupos que melhor sumariza o padr√£o de ocorr√™ncia de esp√©cies de peixes ao longo de um riacho?

::: {.alert .alert-info}
<strong> üìù Importante </strong>\
Neste caso, estamos realizando uma an√°lise explorat√≥ria e n√£o temos uma predi√ß√£o.
:::

**Vari√°veis**

-   Vari√°veis resposta: composi√ß√£o de esp√©cies de peixes

**Checklist**

-   Vamos normalizar os dados de abund√¢ncia antes de entrar na an√°lise propriamente, j√° que existem muitos zeros na matriz

**An√°lises**

Vamos iniciar selecionando e padronizando os dados.

```{r message=FALSE, warning=FALSE}
## Mostrar somente seis primeiras esp√©cies de seis localidades
head(doubs$fish)[,1:6]

## Verificar se existem localidades sem nenhuma ocorr√™ncia
rowSums(doubs$fish)

## Retirar a linha 8 (rio sem nenhuma ocorr√™ncia de peixe)
spe <- doubs$fish[-8,]

## Fun√ß√£o do pacote vegan para normalizar os dados
spe.norm <- decostand(x = spe, method = "normalize") 
```

O argumento `centers` na fun√ß√£o `kmeans()` indica o n√∫mero de grupos que se quer formar. Neste exemplo, estamos utilizando `centers = 4`.

```{r}
## K-Means
spe.kmeans <- kmeans(x = spe.norm, centers = 4, nstart = 100)
spe.kmeans
```

O objeto que fornece o resultado cont√©m: i) o tamanho (n√∫mero de objetos) em cada um dos 4 grupos, ii) o centroide de cada grupo e o pertencimento de cada esp√©cie a cada grupo, e iii) o quanto da Soma de Quadrados dos dados √© explicada por esta conforma√ß√£o de grupos.

No entanto, n√£o √© poss√≠vel saber *a priori* qual o n√∫mero "ideal" de grupos. Para descobrir isso, repetimos o k-means com uma s√©rie de valores de **K**. Isso pode ser feito na fun√ß√£o `cascadeKM()`.

```{r}
## Repetindo o K-Means
spe.KM.cascade <- cascadeKM(spe.norm, inf.gr = 2, sup.gr = 10, iter = 100, criterion = "ssi") 
```

Tanto **calinski** quando **ssi** s√£o bons crit√©rios para encontrar o n√∫mero ideal de grupos. Quanto maior o valor de **ssi**, melhor (veja `?cascadeKM()` mais detalhes). Os valores de ssi √© o crit√©rio utilizado pelo algor√≠timo para achar o agrupamento √≥timo dos objetos (Figura \@ref(fig:fig-kmeans)).

```{r fig-kmeans, fig.cap="Gr√°ficos mostrando os resultados da an√°lise de K-Means.", message=FALSE, warning=FALSE}
## Resumo dos resultados
spe.KM.cascade$results

## Gr√°fico
plot(spe.KM.cascade, sortg = TRUE)
```

**Interpreta√ß√£o dos resultados**

Diferentemente da nossa predi√ß√£o inicial, o resultado da an√°lise mostra que o n√∫mero ideal de grupos para explicar a vari√¢ncia no padr√£o de ocorr√™ncia de esp√©cies √© 3. Notem que o SSI m√°ximo √© alcan√ßado neste n√∫mero de grupos `r spe.KM.cascade$results[2, 2]` (tamb√©m indicado pela bola vermelha no plot).

### Esp√©cies indicadoras

Uma pergunta normalmente feita por ec√≥logos √©: qual esp√©cie pode ser indicadora de uma determinada condi√ß√£o ambiental (e.g., polui√ß√£o)?

O √≠ndice IndVal mede dois aspectos das esp√©cies: fidelidade e especificidade. Uma alta fidelidade significa que esp√©cies ocorrem em todos os locais do grupo, e uma alta especificidade significa que as esp√©cies ocorrem somente naquele grupo. Uma boa esp√©cie indicadora √© aquela na qual todos os indiv√≠duos ocorrem em todas a amostras referentes a um grupo espec√≠fico. A especificidade √© dada pela divis√£o da abund√¢ncia m√©dia da esp√©cie no grupo pela somat√≥rio das abund√¢ncias m√©dias dos grupos. Fidelidade √© igual ao n√∫mero de lugares no grupo onde a esp√©cie est√° presente dividido pelo n√∫mero total de lugares do grupo [@dufrene_species_1997].

Esp√©cies raras podem receber o mesmo valor de IndVal das esp√©cies indicadoras, por√©m s√£o chamadas de indicadoras assim√©tricas, uma vez que contribuem com a especificidade do habitat, mas n√£o servem para predizer grupos. Ao contr√°rio, as esp√©cies indicadoras s√£o verdadeiros indicadores sim√©tricos e podem ser usadas para predizer grupos.

A an√°lise procede da seguinte forma:

1.  Uma matriz de dist√¢ncia √© constru√≠da e as unidades amostrais s√£o classificadas com alguma an√°lise de agrupamento, hier√°rquico ou n√£o

2.  A vari√°vel ambiental para a qual se deseja classificar os grupos √© inserida

3.  As esp√©cies indicadoreas de cada grupo s√£o formadas atrav√©s do c√°lculo da especificidade e fidelidade, obtendo-se o valor de IndVal para cada esp√©cie

4.  Por fim, o conjunto de dados originais √© comparado para ver se a an√°lise faz sentido

O c√°lculo da signific√¢ncia do √≠ndice de IndVal √© feito por aleatoriza√ß√£o de Monte Carlo. Os m√©todos de Monte Carlo utilizam n√∫meros aleat√≥rios de dados reais para simular certos padr√µes esperados na aus√™ncia de um processo ecol√≥gico espec√≠fico [@legendre_numerical_2012]. Assim, o valor do √≠ndice √© aleatorizado 999 vezes (ou o n√∫mero de vezes que voc√™ optar) dentro dos tratamentos e o valor de *P* √© dado pelo n√∫mero de vezes em que o √≠ndice observado foi igual ou maior que os valores aleatorizados. Portanto, o IndVal fornece um conjunto de esp√©cies que s√£o indicadoras de um grupo de locais (e.g., muito polu√≠dos), que por sua vez precisam ser definidos utilizando alguma t√©cnica de agrupamento, como as que vimos anteriormente.

**Exemplo 1**

Para este exemplo, vamos usar o mesmo conjunto de dados utilizado acima com abund√¢ncia de 16 esp√©cies de girinos coletados em 14 po√ßas com diferentes graus de cobertura de dossel na Serra da Bocaina [@provete_broad-scale_2014].

**Pergunta**

-   Podemos utilizar as esp√©cies de girinos como indicadoras da fitofisionomia?

**Predi√ß√µes**

-   Esp√©cies terrestres ser√£o indicadoras de √°rea aberta, enquanto esp√©cies arbor√≠colas ser√£o indicadoras de √°reas florestais

**Vari√°veis**

-   Vari√°veis resposta: mesma matriz j√° utilizada contendo a abund√¢ncia de girinos ao longo de po√ßas na Serra da Bocaina

**An√°lises**

O IndVal est√° dispon√≠vel tanto no pacote `indicspecies`, quando no `labdsv`. Para este exemplo, iremos usar o `labdsv`. Primeiro, vamos agrupar as unidades amostrais (po√ßas) que informa os grupos de fitofisionomias onde as po√ßas se localizam e para os quais deseja-se encontrar esp√©cies indicadoras.

```{r}
## Dados
head(bocaina)
fitofis <- c(rep(1, 4), rep(2, 4), rep(3, 4), rep(4, 4), rep(5, 4))

## An√°lise de esp√©cies indicadoras
res_indval <- indval(t(sp_compos), fitofis)

# A fun√ß√£o summary s√≥ exibe o resultado para as esp√©cies indicadoras
summary(res_indval)
```

Para apresentar uma tabela dos resultados para todas as esp√©cies temos de processar os dados.

```{r}
## Resultados
res_indval$maxcls # classe de maior valor indicador/esp√©cie 
res_indval$indcls # valor indicador (indval)
res_indval$pval # signific√¢ncia do indval
tab_indval <- cbind.data.frame(maxcls = res_indval$maxcls,
                               ind.value = res_indval$indcls,
                               P = res_indval$pval)
tab_indval

## Esp√©cies
tab_indval[tab_indval$P < 0.05, ]
```

**Interpreta√ß√£o dos resultados**

No resultado apresentado, podemos ver que temos duas esp√©cies indicadoras da fitofisionimia 1: *Rhinella icterica* (Rict) e *Scinax duartei* (Sduar). Nenhuma esp√©cie foi indicadora dos outros grupos neste exemplo.

## An√°lises de Ordena√ß√£o

As an√°lises de ordena√ß√£o representam um conjunto de m√©todos e t√©cnicas multivariadas que organizam objetos (e.g., localidades, indiv√≠duos) em alguma ordem considerando o conjunto de descritores que podem estar mais ou menos relacionados entre si. Se os descritores estiverem bem relacionados, eles s√£o redundantes e organizam os objetos de forma similar. Esse fen√¥meno √© observado, por exemplo, quando queremos organizar um conjunto de unidades amostrais baseado em vari√°veis que indicam um mesmo processo: ver o padr√£o de similaridade geral de lagos usando v√°rias vari√°veis relacionada com a produtividade do sistema: clorofila-a, concentra√ß√£o de f√≥sforo, nitrog√™nio, entre outros. Por exemplo, tais m√©todos permitem identificar se existem grupo de esp√©cies que ocorrem exclusivamente em um determinado h√°bitat. Ao buscar esta *ordem*, as t√©cnicas de ordena√ß√£o possuem tr√™s principais utilidades: i) reduzir a dimensionalidade e revelar padr√µes, ii) separar as vari√°veis mais e menos importantes em combina√ß√µes complexas e iii) separar rela√ß√µes mais e menos fortes ao comparar vari√°veis preditoras e dependentes. 

Em geral, os m√©todos s√£o divid√≠dos em ordena√ß√µes irrestritas (ou an√°lise de gradiente indireto) e restritas (ou an√°lise de gradiente direto). As ordena√ß√µes irrestritas organizam os objetos (e.g., esp√©cies) de acordo com sua estrutura de covari√¢ncia (ou correla√ß√£o), o que demonstra que a proximidade (ou dist√¢ncia) dentro do espa√ßo multidimensional representa semelhan√ßa (ou diferen√ßa) dos objetos. Por outro lado, as ordena√ß√µes restritras posicionam os objetos (e.g., esp√©cies) de acordo com sua rela√ß√£o linear com outras vari√°veis coletadas nas mesmas unidades amostraits (e.g., temperatura e precipita√ß√£o). Ao passo que as ordena√ß√µes irrestritas dependem somente de uma matriz (e.g., esp√©cies por localidades), as ordena√ß√µes restritas utilizam no m√≠nimo duas matrizes (e.g., esp√©cies por localidades e vari√°veis clim√°ticas por localidade). Desse modo, fica claro esta diferen√ßa entre os dados utilizados que as an√°lises irrestritas s√£o mais explorat√≥rias, enquanto an√°lises restritas s√£o ideais para testar hip√≥teses com dados multidimensionais. A tabela a seguir apresenta as principais an√°lises utilizadas em ecologia.

+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| M√©todo                   | Tipo de vari√°vel                                                                                                    | Fun√ß√£o R           |
+==========================+=====================================================================================================================+====================+
| **Ordena√ß√£o irrestrita** |                                                                                                                     |                    |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| PCA                      | Vari√°veis cont√≠nuas (dist√¢ncia euclidiana)                                                                          | `PCA()`, `rda()`, `dudi.pca()` |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| PCoA                     | Aceita qualquer tipo de vari√°vel, mas depende da escolha apropriada de uma medida de dist√¢ncia                      | `pcoa()`, `dudi.pco()`     |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| nMDS                     | Aceita qualquer tipo de vari√°vel, mas depende da escolha apropriada de uma medida de dist√¢ncia                      | `metaMDS()`, `nmds()`      |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| CA                       |                                                                                                                     | `dudi.coa()`           |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| Hill-Smith               | Aceita qualquer tipo de vari√°vel                                                                                    | `dudi.hillsmith()`     |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| **Ordena√ß√£o restrita**   |                                                                                                                     |                    |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| RDA                      | Vari√°veis preditoras de qualquer tipo e vari√°veis dependentes cont√≠nuas (ou presen√ßa e aus√™ncia)                    | `rda()`                |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| RDA parcial              | Vari√°veis preditoras de qualquer tipo e vari√°veis dependentes cont√≠nuas (ou presen√ßa e aus√™ncia)                    | `rda()`                |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| dbRDA                    | Vari√°veis preditoras de qualquer tipo e matriz de dist√¢ncia obtida a partir das vari√°veis dependentes               | `capscale()`, `dbrda()`   |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| CCA                      | Vari√°veis preditoras de qualquer tipo e vari√°veis dependentes cont√≠nuas (ou presen√ßa e aus√™ncia)                    | `rda()`               |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| PERMANOVA                | Vari√°veis preditoras de qualquer tipo e matriz de dist√¢ncia obtida a partir das vari√°veis dependentes               | `adonis()`, `adonis2()`    |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+
| PCR                      | Vari√°vel dependente necessariamente representada por escores da PCA ou PCoA e vari√°veis preditoras de qualquer tipo | `pca()`, `pcoa()`, `lm()`, `glm()` |
+--------------------------+---------------------------------------------------------------------------------------------------------------------+--------------------+

## Ordena√ß√£o irrestrira

Ordena√ß√µes irrestritas, ou an√°lise de gradiente indireto ou ainda an√°lises de fator, s√£o um conjunto de m√©todos multivariados que lidam com uma √∫nica matriz quadrada. Esta matriz pode ou n√£o ter pesos nas linhas ou colunas. Geralmente, o objetivo deste tipo de an√°lise √© resumir a informa√ß√£o contida na matriz de maneira gr√°fica, por meio de um diagrama de ordena√ß√£o. Quanto maior e mais complexa for a matriz, mais eficiente √© este tipo de an√°lise. Os tipos de an√°lise ir√£o diferir de acordo com o tipo de dado contido nesta matriz, se cont√≠nuo ou contagem, etc. De maneira geral, essas ordena√ß√µes irrestritas calculam combina√ß√µes lineares, cuja formula√ß√£o ir√° diferir ligeiramente entre os m√©todos. Da mesma forma, essas combina√ß√µes lineares ir√£o preservar um tipo de dist√¢ncia. Por exemplo, a An√°lise de Componentes Principais preserva a dist√¢ncia Euclidiana, enquanto a An√°lise de Correspond√™ncia preserva a dist√¢ncia de chi-quadrado.

### An√°lise de Componentes Principais (PCA)

A An√°lise de Componentes Principais (*Principal Component Analysis* - PCA) √© uma das ordena√ß√µes mais utilizadas em diversas √°reas do conhecimento. Em Ecologia, ela se popularizou por facilitar a visualiza√ß√£o de dados complexos como de distribui√ß√£o de esp√©cies em diferentes localidades e de potenciais vari√°veis explicativas. Ao mesmo tempo que ganhou tamanha popularidade, a PCA tem sido empregada de maneira incorreta, uma vez que muitos estudos utilizam a visualiza√ß√£o gr√°fica da ordena√ß√£o (o biplot) para intepretar "rela√ß√µes" entre vari√°veis preditoras (ambientais) e dependentes (esp√©cies). Por√©m, como informado anteriormente, as ordena√ß√µes irrestritas utilizam a estrutura de covari√¢ncia dos objetos para organizar suas rela√ß√µes de similaridade.

Antes de explicar a an√°lise, imagine que vamos usar uma matriz com cinco esp√©cies de aranhas que foram encontradas em oito cidades diferentes. A quantidade de indiv√≠duos de cada esp√©cie coletada em cada cidade ser√° o valor de preenchimento desta matriz. Sendo assim, a matriz possui oito objetos (cidades, representando unidades amostrais) e cinco descritores (esp√©cies), como na Tabela \@ref(tab:tab-pca-dados).

```{r tab-pca-dados, echo=FALSE}
knitr::kable(data.frame(
    Cidade = paste("Cidade", 1:8),
    `Esp√©cie 1` = c(5, 7, 2, 0, 0, 0, 0, 0),
    `Esp√©cie 2` = c(0, 6, 3, 4, 0, 0, 0, 0),
    `Esp√©cie 3` = c(0, 0, 0, 9, 12, 3, 0, 0),
    `Esp√©cie 4` = c(0, 0, 0, 0, 4, 10, 8, 0),
    `Esp√©cie 5` = c(0, 0, 0, 0, 0, 6, 9, 12)),
    align = "c",
    caption = "Matriz com cinco esp√©cies de aranhas que foram encontradas em oito cidades diferentes.")
```

O primeiro passo da PCA √© obter uma matriz centralizada, onde cada valor √© subtra√≠do da m√©dia da coluna que aquele valor pertence. Esta centraliza√ß√£o pode ser calculada com a fun√ß√£o `scale()`.

```{r}
## Dados
aranhas <- data.frame(
    sp1 = c(5, 7, 2, 0, 0, 0, 0, 0),
    sp2 = c(0, 6, 3, 4, 0, 0, 0, 0),
    sp3 = c(0, 0, 0, 9, 12, 3, 0, 0),
    sp4 = c(0, 0, 0, 0, 4, 10, 8, 0),
    sp5 = c(0, 0, 0, 0, 0, 6, 9, 12),
    row.names = paste0("cidade", 1:8))

## Centraliza√ß√£o
aranha.cent <- as.data.frame(base::scale(aranhas, center = TRUE, scale=FALSE))
```

O segundo passo √© calcular uma matriz de covari√¢ncia (ou matriz de dispers√£o) e, a partir desta matriz, obter os autovalores e autovetores. Os autovalores representam a porcentagem de explica√ß√£o de cada eixo e podem ser calculados dividindo a soma do autovalor de cada eixo pela soma de todos os autovalores. No exemplo que apresentamos, os dois primeiros eixos representam 47,20% e 35,01% de toda varia√ß√£o, respectivamente. Os autovetores, por sua vez, representam os valores que multiplicam as vari√°veis originais e, desse modo, indicam a dire√ß√£o desses valores. Por fim, os componentes principais (Matriz F) s√£o obtidos multiplicando os autovetores com os valores da matriz centralizada.

```{r}
## Matriz de covai√¢ncia
matriz_cov <- cov(aranha.cent)

## Autovalores e autovetores
eigen_aranhas <- eigen(matriz_cov)
autovalores <- eigen_aranhas$values
autovetores <- as.data.frame(eigen_aranhas$vectors)
autovalores # eigenvalue
colnames(autovetores) <- paste("PC", 1:5, sep="")
rownames(autovetores) <- colnames(aranhas)
autovetores

## Componentes principais
matriz_F <- as.data.frame(as.matrix(aranha.cent) %*% as.matrix(autovetores))
matriz_F

## Porcentagem de explica√ß√£o de cada eixo
100 * (autovalores/sum(autovalores))
```

Agora, √© poss√≠vel visualizar a rela√ß√£o entre as cidades e similaridade na esp√©cies de aranhas que vivem em cada uma delas (Figura \@ref(fig:fig-pca)).

```{r fig-pca, fig.cap="Biplot da PCA ordenando as cidades pela composi√ß√£o das esp√©cies de aranhas.", message=FALSE, warning=FALSE}
## Gr√°fico
ggplot(matriz_F, aes(x = PC1, y = PC2, label = rownames(matriz_F))) +
    geom_label() + 
    geom_hline(yintercept = 0, linetype=2) +
    geom_vline(xintercept = 0, linetype=2) +
    tema_livro()
```

**Checklist**

-   Verifique se todas as vari√°veis utilizadas s√£o cont√≠nuas. Caso contr√°rio, considere utilizar PCoA (veja mais no pr√≥ximo t√≥pico)

-   Apesar do exemplo acima ter apresentado a ocorr√™ncia de esp√©cies de aranhas em diferentes cidades, √© fundamental saber que utilizar a PCA com esses dados pode ser problem√°tico. Assim, tenha cuidado em usar dados de composi√ß√£o de esp√©cies, especialmente abund√¢ncia, com PCA, uma vez que 'duplos zeros' podem gerar distor√ß√µes na ordena√ß√£o [@legendre_numerical_2012]. Como alternativa, √© poss√≠vel utilizar PCA com dados padronizados com o m√©todo de Hellinger [@legendre2001].

**Exemplo 1**

Neste exemplo vamos utilizar um conjunto de dados morfol√≥gicos de pinguins do arquip√©lago Palmer (Pen√≠nsula Ant√°rtica) dispon√≠veis no pacote 'palmerpenguins'. Os dados representam medidas do comprimento e largura do bico (mm), comprimento da nadadeira (mm) e massa corporal (gramas) de tr√™s esp√©cies: Ad√©lie, Chinstrap e Gentoo. Como descrito acima, a PCA deve ser utilizada para explora√ß√£o de dados ou para testes *a posteriori* (e.g., Regress√£o de Componentes Principais - PCR, t√≥pico explorado mais a frente nesse cap√≠tulo). Neste exemplo, iremos usar a estrutura de perguntas e predi√ß√µes para manter a proposta do livro.

**Pergunta**

-   Existe diferen√ßas nas caracter√≠sticas morfol√≥gicas das esp√©cies de pinguins do arquip√©lago Palmer?

**Predi√ß√µes**

-   Pinguins com dieta diferente possuem diferentes caracter√≠sticas morfol√≥gicas

**Vari√°veis**

-   Preditora: esp√©cie (categ√≥rica com tr√™s n√≠veis)
-   Dependentes: vari√°veis morfol√≥gicas (cont√≠nua)

**An√°lises**

Antes de come√ßar, √© necess√°rio remover dados ausentes (se houver) e editar nomes das vari√°veis (ponto importante para determinar como devem aparecer no gr√°fico).

```{r message=FALSE, warning=FALSE}
## Verificar se existem NAs nos dados
sum(is.na(penguins))

## Remover dados ausentes (NA), quando houver
penguins <- na.omit(penguins)

## Manter somentes dados cont√≠nuos que pretende aplicar a PCA
penguins_trait <- penguins[, 3:6]
```

Agora sim, os dados est√£o prontos para fazer a PCA. Um argumento √© essencial na an√°lise, o `scale.unit`. Se voc√™ utilizar dentro deste argumento o sele√ß√£o `TRUE`, a fun√ß√£o padroniza automaticamente as vari√°veis para terem a m√©dia 0 e vari√¢ncia 1. Esta padroniza√ß√£o √© essencial quando as vari√°veis est√£o em escalas muito diferentes. No exemplo selecionado, temos vari√°veis como comprimento do bico (em mil√≠metros) e massa corporal (em gramas).

```{r message=FALSE, warning=FALSE}
## Compare com este c√≥digo a vari√¢ncia das vari√°veis
penguins_trait %>% 
    dplyr::summarise(across(where(is.numeric), 
                            ~var(.x, na.rm = TRUE)))

## Agora, veja o mesmo c√°lculo se fizer a padroniza√ß√£o (scale.unit da fun√ß√£o PCA)
penguins_pad <- decostand(x = penguins_trait, method = "standardize")
penguins_pad %>% 
    dplyr::summarise(across(where(is.numeric), 
                            ~var(.x, na.rm = TRUE)))

## PCA
pca.p <- PCA(X = penguins_trait, scale.unit = TRUE, graph = FALSE)
```

Apesar da simplicidade do c√≥digo para executar a PCA, o objeto resultante da an√°lise possui diversas informa√ß√µes que s√£o essenciais para sua plena interpreta√ß√£o. Dentre elas, se destacam os autovalores, escores e cargas (*loadings*). Os autovalores representam a porcentagem de explica√ß√£o de cada eixo. Os escores representam as coordenadas (posi√ß√µes no espa√ßo multidimensional) representando os objetos (geralmente localidades ou indiv√≠duos) e descritores (geralmente esp√©cies ou vari√°veis ambientais e espaciais). Os *loadings*, por sua vez, representam a combina√ß√£o linear entre os escores (nova posi√ß√£o do valor do descritor no espa√ßo ordenado) e os valores originais dos descritores (Figura \@ref(fig:fig-pca-scree)).

```{r fig-pca-scree, fig.cap="Scree plot mostrando a porcentagem de contribui√ß√£o de cada eixo para a ordena√ß√£o dos dados de penguins.", message=FALSE, warning=FALSE}
## Autovalores: porcentagem de explica√ß√£o para usar no gr√°fico
pca.p$eig 

## Visualiza√ß√£o da porcentagem de explica√ß√£o de cada eixo
# nota: √© necess√°rio ficar atento ao valor m√°ximo do eixo 1 da an√°lise para determinar o valor do ylim (neste caso, colocamos que o eixo varia de 0 a 70).
fviz_screeplot(pca.p, addlabels = TRUE, ylim = c(0, 70), main = "", 
               xlab = "Dimens√µes",
               ylab = "Porcentagem de vari√¢ncia explicada") 
## Outros valores importantes
var_env <- get_pca_var(pca.p)

## Escores (posi√ß√£o) das vari√°veis em cada eixo
var_env$coord 

## Contribui√ß√£o (%) das vari√°veis para cada eixo
var_env$contrib 

## Loadings - correla√ß√£o das vari√°veis com os eixos
var_env$cor 

## Qualidade da representa√ß√£o da vari√°vel. Esse valor √© obtido multiplicado var_env$coord por var_env$coord
var_env$cos2

## Escores (posi√ß√£o) das localidades ("site scores") em cada eixo 
ind_env <- get_pca_ind(pca.p)
```

O pacote `FactoMineR` criou uma fun√ß√£o (`dimdesc()`) que seleciona as melhores vari√°veis (aquelas mais explicativas) para cada eixo atrav√©s de uma an√°lise fatorial. No exemplo com pinguins, o primeiro eixo (objeto `pca.p$eig`) explica \~69% da varia√ß√£o morfol√≥gica. A fun√ß√£o `dimdesc()` mostra que as quatro vari√°veis morfol√≥gicas est√£o fortemente associadas com o eixo 1. Por√©m, enquanto comprimento da nadadeira, massa corporal e comprimento do bico est√£o positivamente associados com o eixo 1 (correla√ß√£o positiva), a largura do bico tem rela√ß√£o negativa. O eixo 2, por sua vez, explica \~20% da varia√ß√£o, sendo relacionado somente com largura e comprimento do bico.

```{r message=FALSE, warning=FALSE}
## Vari√°veis mais importantes para o Eixo 1
dimdesc(pca.p)$Dim.1 

## Vari√°veis mais importantes para o Eixo 2
dimdesc(pca.p)$Dim.2 
```

Agora podemos utilizar o famoso **biplot** para representar a compara√ß√£o morfol√≥gica dos pinguins dentro e entre esp√©cies (Figura \@ref(fig:fig-pca-biplot)).

```{r fig-pca-biplot, fig.cap="Biplot da PCA ordenando os dados morfol√≥gicos de penguins.", message=FALSE, warning=FALSE}
fviz_pca_biplot(X = pca.p, 
                geom.ind = "point", 
                fill.ind = penguins$especies, 
                col.ind = "black",
                alpha.ind = 0.7,
                pointshape = 21, 
                pointsize = 4,
                palette = c("darkorange", "darkorchid", "cyan4"),
                col.var = "black",
                invisible = "quali",
                title = NULL) +
    labs(x = "PC1 (68.63%)", y = "PC2 (19.45%)") + 
    xlim(c(-3, 4)) +
    ylim(c(-3, 3)) +
    tema_livro()
```

### An√°lises de Coordenadas Principais (PCoA)

Diferentemente da PCA, a An√°lises de Coordenadas Principais (*Principal Coordinate Analysis* - PCoA) √© uma an√°lise de ordena√ß√£o irrestrita que aceita dados de diferentes tipos, como cont√≠nuos, categ√≥ricos, ordinais, bin√°rios, entre outros. Assim, a PCoA √© aplicada para casos em que a dist√¢ncia euclidiana n√£o √© aplicada (como na PCA). Desse modo, o primeiro passo da an√°lise √© calcular uma matriz de similaridade ou de dist√¢ncia (discutido acima). Depois, os passos para obter autovalores e autovetores s√£o bastante parecidos com a PCA. Da mesma forma, os eixos da PCoA e os valores ou posi√ß√µes dos objetos nesses eixos representam a rela√ß√£o de semelhan√ßa (ou diferen√ßa) baseada nos descritores desses objetos. A diferen√ßa, neste caso, √© que a PCoA representa um espa√ßo n√£o-euclidiano, que ir√° ser afetado pela escolha do m√©todo de similaridade.

As utiliza√ß√µes mais comuns da PCoA s√£o a ordena√ß√£o: i) da matriz de composi√ß√£o de esp√©cies usando a dist√¢ncia apropriada (Jaccard, Sorensen, Bray-Curtis), ii) da matriz de vari√°veis ambientais com mistos (cont√≠nuos, categ√≥ricos, circulares, etc.), e iii) da matriz filogen√©tica [m√©todo PVR @diniz-filho_eigenvector_1998]. Abaixo, exemplificamos a ordena√ß√£o da matriz de composi√ß√£o de esp√©cies.

**Checklist**

-   Compare as dimens√µes das matrizes utilizadas para a PCoA. Com bastante frequ√™ncia, a tentativa de combinar dados categ√≥ricos (algum descritor dos objetos) com os valores obtidos com a PCoA gera erros para plotar a figura ou para executar a an√°lise. Verifique, ent√£o, se as linhas s√£o as mesmas (nome das localidades ou indiv√≠duos e quantidade)

-   √â fundamental conhecer o tipo de dados que est√° usando para selecionar a medida de dist√¢ncia apropriada. Essa escolha vai afetar a qualidade da ordena√ß√£o e sua habilidade para interpretar a rela√ß√£o de semelhan√ßa entre os objetos comparados

-   Diferente da PCA, a PCoA aceita dados ausentes se a medida de dist√¢ncia escolhida tamb√©m n√£o tiver esta limita√ß√£o. Por exemplo, a dist√¢ncia de Gower produz matrizes de similaridade mesmo com dados ausentes em determinados objetos

-   Em alguns casos, autovalores negativos s√£o produzidos na ordena√ß√£o com PCoA. Veja as principais causas desses valores em Legendre & Legendre [-@legendre_numerical_2012]. Apesar deste problema, os autovalores mais importantes (eixos iniciais) n√£o s√£o afetados e, deste modo, a qualidade da representa√ß√£o dos objetos no espa√ßo multidimensional n√£o √© afetada. Alguns autores sugerem utilizar corre√ß√µes m√©todos de corre√ß√£o, como Lingoes ou Cailliez [@legendre_numerical_2012].

**Exemplo 1**

Neste exemplo, vamos utilizar a composi√ß√£o de √°caros Oribatidae em 70 manchas de musgo coletados por Borcard et al. [-@borcard_partialling_1992].

**Pergunta**

-   A composi√ß√£o de esp√©cies de √°caros muda entre diferentes topografias?

**Predi√ß√µes**

-   Iremos encontrar ao menos dois grupos de esp√©cies: aquelas que ocorrem em po√ßas dentro de floresta *versus* aquelas que ocorrem em po√ßas de √°reas abertas

**Vari√°veis**

-   Preditora: topografia (categ√≥rica com dois n√≠veis)
-   Dependentes: composi√ß√£o de esp√©cies de √°caro

**An√°lises**

Vamos primeramente padronizar dos dados, calcular uma matriz de dist√¢ncia com m√©todo Bray-Curtis e depois calcular a PCoA.

```{r message=FALSE, warning=FALSE}
## Padroniza√ß√£o dos dados com Hellinger
mite.hel <- decostand(x = mite, method = "hellinger") 

## C√°lculo da matriz de dist√¢ncia com m√©todo Bray-Curtis
sps.dis <- vegdist(x = mite.hel, method = "bray") 

## PCoA
pcoa.sps <- pcoa(D = sps.dis, correction = "cailliez")
```

Assim como na PCA, a porcentagem de explica√ß√£o dos eixos √© uma das informa√ß√µes mais importantes pois descrevem a efetividade da redu√ß√£o da dimensionalidade dos dados.

```{r message=FALSE, warning=FALSE}
## Porcentagem de explica√ß√£o do Eixo 1
100 * (pcoa.sps$values[, 1]/pcoa.sps$trace)[1]

## Porcentagem de explica√ß√£o dos Eixo 2
100 * (pcoa.sps$values[, 1]/pcoa.sps$trace)[2]

## Porcentagem de explica√ß√£o acumulada dos dois primeiros eixos 
sum(100 * (pcoa.sps$values[, 1]/pcoa.sps$trace)[1:2])

## Selecionar os dois primeiros eixos
eixos <- pcoa.sps$vectors[, 1:2]

## Juntar com algum dado categ√≥rico de interesse para fazer a figura
pcoa.dat <- data.frame(topografia = mite.env$Topo, eixos)
```

Para visualizar os resultados da PCoA, vamos exportar os escores dos eixos para usar no pacote `ggplot2` (Figura \@ref(fig:fig-pcoa-biplot)).

```{r fig-pcoa-biplot, fig.cap="Biplot da PCoA ordenando as esp√©cies de √°caros entre diferentes topografias.", message=FALSE, warning=FALSE}
## Escores dos dois primeiros eixos
eixos <- pcoa.sps$vectors[, 1:2] 

## Combinar dados dos escores com um dado categ√≥rico de interesse para nossa pergunta
pcoa.dat <- data.frame(topografia = mite.env$Topo, eixos)

### Gr√°fico biplot da PCoA
ggplot(pcoa.dat, aes(x = Axis.1, y = Axis.2, fill = topografia, 
                     color = topografia, shape = topografia)) +
    geom_point(size = 4, alpha = 0.7) + 
    scale_shape_manual(values = c(21, 22)) + 
    scale_color_manual(values = c("black", "black")) + 
    scale_fill_manual(values = c("darkorange", "cyan4")) + 
    labs(x = "PCO 1 (49.11%)", y = "PCO 2 (14.30%)") + 
    geom_hline(yintercept = 0, linetype = 2) + 
    geom_vline(xintercept = 0, linetype = 2) +
    tema_livro()
```

**Limita√ß√µes importantes das ordena√ß√µes irrestritas**

Com frequ√™ncia, pesquisadores utilizam an√°lises como PCA e PCoA para "testar" diferen√ßas na composi√ß√£o de esp√©cies entre determinados fatores relevantes (altitude, clima, etc.). Por√©m, como falado acima, as an√°lises de ordena√ß√£o irrestritas n√£o s√£o utilizadas para testar qualquer hip√≥tese. Ao inv√©s disso, essas an√°lises representam uma poderosa ferramente para explorar padr√µes em vari√°veis dependentes ou independentes para ajudar na interpreta√ß√£o ou mesmo para testar hip√≥teses em an√°lises combinadas com as ordena√ß√µes restritas.

### Regress√£o de Componentes Principais (PCR)

Uma maneira de testar hip√≥teses utilizando ordena√ß√µes irrestritas √© utilizando os resultados da ordena√ß√£o (escores) como vari√°veis preditoras ou dependentes como, por exemplo, em modelos lineares (e.g., regress√£o m√∫ltipla Cap√≠tulo \@ref(cap7)). O primeiro passo √© utilizar uma ordena√ß√£o, como a PCA, para gerar os "novos" dados que ser√£o usados na an√°lise. A utiliza√ß√£o desses novos dados (que representam as coordenadas principais ou escores da PCA) vai depender da pergunta em quest√£o. Por exemplo, pode ser que esses valores representem gradientes clim√°ticos e, por este motivo, ser√£o utilizados como vari√°veis preditoras em um modelo linear (e.g., regress√£o m√∫ltipla). Por outro lado, esses valores podem representar o espa√ßo morfol√≥gicos de esp√©cies de peixes e, como consequ√™ncia, ser√£o utilizados como vari√°veis dependentes para entender o efeito da presen√ßa de predador sobre a morfologia. √â importante ressaltar que existem algumas limita√ß√µes importantes na PCR como, por exemplo, as coordenadas principais (escores da PCA) utilizadas como vari√°veis preditoras podem n√£o representam, biologicamente, as mais importantes para explicar a varia√ß√£o na vari√°vel resposta [@hadi_cautionary_1998].   


**Checklist**

-   Compare as dimens√µes das matrizes utilizadas para a PCR. Com bastante frequ√™ncia, a tentativa de combinar dados categ√≥ricos (algum descritor dos objetos) com os valores obtidos com a PCoA gera erros para plotar a figura ou para executar a an√°lise. Verifique, ent√£o, se as linhas s√£o as mesmas (nome das localidades ou indiv√≠duos e quantidade)

-   Estudos recentes t√™m criticado a utiliza√ß√£o de PCR para testar hip√≥teses ecol√≥gicas pelo fato dos escores n√£o representarem, necessariamente, a varia√ß√£o total das vari√°veis originais, bem como a rela√ß√£o entre a vari√°vel preditora e a dependente

**Exemplo 1**

Neste exemplo, vamos utilizar a composi√ß√£o de esp√©cies de aves em 23 regi√µes dos alpes franceses. Os dados ambientais (env) representam vari√°veis clim√°ticas (temperatura e chuva) e altitude.

**Pergunta**

-   Gradientes clim√°ticos afetam a riqueza de aves?

**Predi√ß√µes**

-   O aumento da umidade e redu√ß√£o da temperatura aumentam o n√∫mero de esp√©cies de aves

**Vari√°veis**

-   Preditora: temperatura e chuva (cont√≠nuas) e altitude (categ√≥rica com tr√™s n√≠veis)
-   Dependentes: riqueza de esp√©cies de aves

```{r message=FALSE, warning=FALSE}
## Dados
env_cont <- env[,-8]
env.pca <- PCA(env_cont, scale.unit = TRUE, graph = FALSE)
var_env <- get_pca_var(env.pca) 

## Contribui√ß√£o (%) das vari√°veis para cada eixo
var_env$contrib 

## Loadings - correla√ß√£o das vari√°veis com os eixos
var_env$cor 
ind_env <- get_pca_ind(env.pca)
env.pca$eig 
```

O objeto `env.pca$eig` demonstra que os tr√™s primeiros eixos explicam 94.54% da varia√ß√£o total dos dados clim√°ticos. O intuito da PCR √© reduzir a dimensionalidade, ou seja, o n√∫mero de vari√°veis preditoras ou depedentes para facilitar a interpreta√ß√£o e garantir que as vari√°veis n√£o sejam correlacionadas. O pr√≥ximo passo ent√£o √© obter os valores dos escores que representam os valores convertidos para serem usados em uma determinada an√°lise, como a regress√£o m√∫ltipla.

```{r}
## Passo 1: obter os primeiros eixos 
pred.env <- ind_env$coord[, 1:3] 

## Passo 2: calcular a riqueza de esp√©cies
riqueza <- specnumber(species)

## Passo 3: combinar os dois valores em um √∫nico data.frame
dat <- data.frame(pred.env, riqueza) 
```

Agora que os dados foram combinados em uma √∫nico data frame, podemos utilizar os c√≥digos apresentados no Cap√≠tulo \@ref(cap7) para testar nossa hip√≥tese (Figura \@ref(fig:fig-pcr-aves-diag)).

```{r fig-pcr-aves-diag, fig.cap="Diagn√≥sticos dos modelo PCR para aves.", message=FALSE, warning=FALSE}
## Regress√£o m√∫ltipla
mod1 <- lm(riqueza ~ Dim.1 + Dim.2 + Dim.3, data = dat)
par(mfrow = c(2, 2))
plot(mod1) # verificar pressupostos dos modelos lineares
summary(mod1) # resultados do  teste
dimdesc(env.pca)$Dim.1 
```

Como percebemos, a Dim.1 foi o √∫nico gradiente ambiental que afetou a riqueza de esp√©cies. Para interpretar esta dimens√£o (e outras importantes), podemos usar a fun√ß√£o `dimdesc()` para verificar as vari√°veis mais importantes. Neste caso, os valores mais extremos de correla√ß√£o (maior que 0.8) indicam que a temperatura do m√™s de janeiro e julho bem como a chuva do m√™s de julho foram as vari√°veis mais importantes para determinar o gradiente ambiental expresso na dimens√£o 1. Assim, podemos fazer um gr√°fico para representar a rela√ß√£o entre Eixo 1 (gradiente chuva-temperatura) e a riqueza de esp√©cies de aves. Valores negativos do eixo 1 (Gradiente ambiental - PC1) representam localidades com mais chuva, ao passo que valores positivos indicam localidades com temperaturas maiores (Figura \@ref(fig:fig-pcr-aves-model)).

```{r fig-pcr-aves-model, fig.cap="Modelo linear representando a rela√ß√£o entre Eixo 1 (gradiente chuva-temperatura) e a riqueza de esp√©cies de aves.", message=FALSE, warning=FALSE}
ggplot(dat, aes(x = Dim.1, y = riqueza)) + 
    geom_smooth(method = lm, fill = "#525252", color = "black") + 
    geom_point(size = 4, shape = 21, alpha = 0.7, color = "#1a1a1a", fill = "cyan4") +
    labs(x = "Gradiente ambiental (PC1)", y = "Riqueza de aves") + 
    tema_livro()
```

**Exemplo 2**

√â poss√≠vel que os dados utilizados em seu estudo sejam mistos, ou seja, incluem tanto vari√°veis categ√≥ricas quanto cont√≠nuas. Como falado acima, nesses casos a an√°lise indicada √© a PCoA. Assim como na PCA, podemos extrair os escores da PCoA para utilizar em an√°lises univariadas e multivariadas.

**Pergunta**

-   Vari√°veis clim√°ticas, vegetacionais e topogr√°ficas afetam a riqueza de √°caros?

**Predi√ß√µes**

-   A densidade da vegeta√ß√£o e disponibilidade de √°gua aumentam a riqueza de esp√©cies de √°caros

**Vari√°veis**

-   Preditoras: densidade de substrado e disponibilidade de √°gua (cont√≠nuas), tipo de substrado (categ√≥rica com 7 n√≠veis), densidade arbusto (ordinal com 3 n√≠veis), e topografia (categ√≥rica com 2 n√≠veis)
-   Dependentes: riqueza de esp√©cies de √°caros

O primeiro passo ent√£o √© utilizar um m√©todo de dist√¢ncia apropriado para o seu conjunto de dados. Em nosso exemplo, utilizaremos a dist√¢ncia de Gower, que √© usada para dados mistos (veja Cap√≠tulo \@ref(cap14)).

```{r message=FALSE, warning=FALSE}
## Matriz de dist√¢ncia
env.dist <- gowdis(mite.env)

## PCoA
env.mite.pco <- pcoa(env.dist, correction = "cailliez")

## Porcentagem de explica√ß√£o do Eixo 1
100 * (env.mite.pco$values[, 1]/env.mite.pco$trace)[1]

## Porcentagem de explica√ß√£o dos Eixo 2
100 * (env.mite.pco$values[, 1]/env.mite.pco$trace)[2]
```

O pr√≥ximo passo √© exportar os escores para as an√°lises *a posteriori* (Figura \@ref(fig:fig-pcr-acaros-diag)).

```{r fig-pcr-acaros-diag, fig.cap="Diagn√≥sticos dos modelo PCR para √°caros.", message=FALSE, warning=FALSE}
## Selecionar os dois primeiros eixos
pred.scores.mite <- env.mite.pco$vectors[, 1:2] 

## Juntar com os dados da √°rea para fazer a figura 
mite.riqueza <- specnumber(mite)
pred.vars <- data.frame(riqueza = mite.riqueza, pred.scores.mite)

### Regress√£o m√∫ltipla 
mod.mite <- lm(riqueza ~ Axis.1 + Axis.2, data = pred.vars)
par(mfrow = c(2, 2))
plot(mod.mite)
summary(mod.mite)
```

Finalmente, ap√≥s interpretar os resultados do modelo, podemos fazer a figura com as vari√°veis (eixos) importantes (Figura \@ref(fig:fig-pcr-acaros-model)).

```{r fig-pcr-acaros-model, fig.cap="Modelo linear representando a rela√ß√£o entre Eixo 1 e Eixo 2 e a riqueza de esp√©cies de √°caros.", message=FALSE, warning=FALSE}
g_acari_axi1 <- ggplot(pred.vars, aes(x = Axis.1, y = riqueza)) + 
    geom_smooth(method = lm, fill = "#525252", color = "black") + 
    geom_point(size = 4, shape = 21, alpha = 0.7, color = "#1a1a1a", fill="cyan4") + 
    labs(x = "Gradiente ambiental (PC1)", y = "Riqueza de √°caros") + 
    tema_livro()

g_acari_axi2 <- ggplot(pred.vars, aes(x = Axis.2, y = riqueza)) + 
    geom_smooth(method = lm, fill = "#525252", color = "black") + 
    geom_point(size = 4, shape = 21, alpha = 0.7, color = "#1a1a1a", fill = "darkorange") + 
    labs(x = "Gradiente ambiental (PC2)", y = "Riqueza de √°caros") + 
    tema_livro()

## Fun√ß√£o para combinar os dois plots em uma √∫nica janela
grid.arrange(g_acari_axi1, g_acari_axi2, nrow = 1)
```

## Ordena√ß√£o restrita

A ordena√ß√£o restrita ou an√°lise de gradiente direto, organiza os objetos de acordo com suas rela√ß√µes com outras vari√°veis (preditoras) coletadas nas mesmas unidades amostrais. O exemplo mais comum na ecologia √© de investigar a rela√ß√£o entre diversas vari√°veis ambientais (matriz **X**) coletadas em *n* localidades e a abund√¢ncia (ou presen√ßa aus√™ncia) de *y* esp√©cies coletadas nas mesmas localidades (matrix **Y**). Com frequ√™ncia, outras dados s√£o utilizados como as coordenadas geogr√°ficas das unidades amostrais (matriz **W**), os atributos funcionais das esp√©cies coletadas (matriz **T**) e a rela√ß√£o filogen√©tica dessas esp√©cies (matriz **P**). Diversos m√©todos s√£o utilizados para combinar duas ou mais matrizes, mas neste cap√≠tulo iremos apresentar a An√°lise de Redund√¢ncia (RDA), An√°lise de Redund√¢ncia parcial (RDAp) e m√©todos espaciais para incluir a matriz **W** nas an√°lises de gradiente direto.

### An√°lise de Redund√¢ncia (RDA)

A RDA √© uma an√°lise semelhante √† regress√£o m√∫ltipla (Cap√≠tulo \@ref(cap7)), mas que usa dados multivariados como vari√°vel dependente. As duas matrizes comuns, matriz X (*n* unidades amostraits e *m* vari√°veis) e matriz Y (*n* unidades amostrais e *p* descritores - geralmente, esp√©cies). O primeiro passo da RDA √© centralizar (assim como na PCA, exemplo acima) as matrizes X e Y. Ap√≥s a centraliza√ß√£o, realiza-se regress√µes lineares entre X e Y para obter os valores preditos de Y (ou seja, os valores de Y que representa√ß√£o uma combina√ß√£o linear com X). O passo seguinte √© realizar uma PCA dos valores preditos de Y. Este √∫ltimo procedimento gera os autovalores, autovetores e os eixos can√¥nicos que correspondem √†s coordenadas dos objetos (unidades amostrais), vari√°veis preditoras e das vari√°veis resposta. A diferen√ßa da ordena√ß√£o do valor de Y predito e da ordena√ß√£o somente de Y (como na PCA implementada acima) √© que a segunda mostra a posi√ß√£o prevista pela rela√ß√£o linear entre X e Y. Logo, essa √© exatamente o motivo da ordena√ß√£o ser conhecida como restrita, pois a varia√ß√£o em Y √© restrita (linearmente) pela varia√ß√£o de X. Assim como na regress√£o m√∫ltipla, a estat√≠stica da RDA √© representada pelo valor de *R^2^* e *F*. O valor de *R^2^* indica a for√ßa da rela√ß√£o linear entre X e Y e o valor do *F* representa o teste global de signific√¢ncia. Al√©m disso, √© poss√≠vel testar a signific√¢ncia de cada um dos eixos da ordena√ß√£o (e a presen√ßa de pelo menos um eixo significativo √© pr√©-requisito para que exista a rela√ß√£o linear entre X e Y) e de cada uma das vari√°veis preditoras da matriz X.

**Checklist**

-   Vari√°veis preditoras: importante verificar se: i) a estrutura de correla√ß√£o das vari√°veis ambientais, e a ii) presen√ßa de autocorrela√ß√£o espacial

-   Composi√ß√£o de esp√©cies como matriz Y: fundamental observar se os valores utilizados representam abund√¢ncia ou presen√ßa-aus√™ncia e qual a necessidade de padroniza√ß√£o (e.g., Hellinger)

-   Assim como em modelos de regress√£o linear simples e m√∫ltipla, os valores de *R^2^* ajustado devem ser selecionados ao inv√©s do valor de *R^2^*

**Exemplo 1**

Esp√©cies de aves que ocorrem em localidades com diferentes altitudes.

**Pergunta**

-   O clima e a altitude modificam a composi√ß√£o de esp√©cies de aves?

**Predi√ß√µes**

-   Diferen√ßas clim√°ticas (temperatura e chuva) e altitudinais alteram a composi√ß√£o de esp√©cies de aves

**Vari√°veis**

-   Preditoras: Temperatura e precipita√ß√£o (cont√≠nuas) e altitude (categ√≥rica com tr√™s n√≠veis)
-   Dependente: composi√ß√£o de esp√©cies de aves

**An√°lises**

```{r message=FALSE, warning=FALSE}
## Passo 1: transforma√ß√£o de hellinger da matriz de esp√©cies
# caso tenha dados de abund√¢ncia.
species.hel <- decostand(x = species, method = "hellinger")

## Passo 2: selecionar vari√°veis importantes
# Para isso, √© necess√°rio remover a vari√°vel categ√≥rica.
env.contin <- env[, -8]

## Evite usar vari√°veis muito correlacionadas
sel.vars <- forward.sel(species.hel, env.contin)
sel.vars$variables
env.sel <- env[,sel.vars$variables]

## Passo 3: padronizar matriz ambiental (somente vari√°veis cont√≠nuas)
env.pad <- decostand(x = env.sel, method = "standardize")

## Matriz final com vari√°veis preditoras
env.pad.cat <- data.frame(env.pad, altitude = env$altitude)
```

Depois de selecionar um subconjunto dos dados com o m√©todo Forward Selection e padroniz√°-los (m√©dia 0 e desvio padr√£o 1), o modelo da RDA √© constru√≠do como modelos lineares (Figura \@ref(fig:fig-rda)). A Ordena√ß√£o Multi-Escala (MSO) tamb√©m √© ajustada para analisar a autocorrela√ß√£o espacial.

```{r fig-rda, fig.cap="Ordena√ß√£o multi-escala (MSO) para entender os resultados da ordena√ß√£o em rela√ß√£o √† dist√¢ncia geogr√°fica.", message=FALSE, warning=FALSE}
## RDA com dados selecionados e padronizados
rda.bird <- rda(species.hel ~ rain.jul + maxi.jul + altitude, data = env.pad.cat)

## Para interpretar, √© necess√°rio saber a signific√¢ncia dos eixos para representar a rela√ß√£o entre as vari√°veis preditoras e a composi√ß√£o de esp√©cies
res.axis <- anova.cca(rda.bird, by = "axis") 
res.axis

## Em seguida, √© poss√≠vel identificar quais s√£o as vari√°veis que contribuem ou que mais contribuem para a varia√ß√£o na composi√ß√£o de esp√©cies 
res.var <- anova.cca(rda.bird, by = "term") ## Qual vari√°vel?
res.var

## Al√©m disso, √© poss√≠vel obter o valor do R2 do modelo
r_quadr <- RsquareAdj(rda.bird)
r_quadr

## Ordena√ß√£o multi-escala (MSO) para entender os resultados da ordena√ß√£o em rela√ß√£o √† dist√¢ncia geogr√°fica
bird.rda <- mso(rda.bird, xy, grain = 1, permutations = 99)
msoplot(bird.rda)
```

Da mesma forma que nas ordena√ß√µes irrestritas, podemos fazer um gr√°fico para visualizar as ordena√ß√µes, mas agora esse gr√°fico √© denominado "triplot", pois possui os dados das duas ordena√ß√µes (Figura \@ref(fig:fig-rda-triplot)).

```{r fig-rda-triplot, fig.cap="Triplot da RDA.", message=FALSE, warning=FALSE}
## Triplot da RDA
ggord(rda.bird, ptslab = TRUE, size = 1, addsize = 3, repel = TRUE) +
    geom_hline(yintercept = 0, linetype = 2) +
    geom_vline(xintercept = 0, linetype = 2) + 
    tema_livro()
```

**Interpreta√ß√£o dos resultados**

Os objetos `res.axis`, `res.var` e `r_quadr` mostram, respectivamente, i) as dimens√µes (RDA1, RDA2, etc.) que possuem varia√ß√£o na composi√ß√£o de esp√©cies, ii) as vari√°veis preditoras que explicam esta varia√ß√£o, e iii) o valor do *R^2^* ajustado. Neste exemplo, podemos observar que somente a dimens√£o 1 (RDA1) representa uma varia√ß√£o significativa da composi√ß√£o de esp√©cies (**P** = 0,001). As vari√°veis *rain.jul*, *maxi.jul* e *altitude* foram todas preditoras importantes da composi√ß√£o de esp√©cies, mas *rain.jul* se destacada com maior valor de **F**. Al√©m disso, o valor do *R^2^* ajustado de 0.381 indica forte contribui√ß√£o dessas vari√°veis preditoras. Por√©m, uma das limita√ß√µes desta an√°lise √© n√£o considerar que tanto esp√©cies quanto vari√°veis preditoras podem estar estruturadas espacialmente. Como resultado, os res√≠duos da an√°lises podem apresentar autocorrela√ß√£o espacial que, por sua vez, aumenta o Erro do Tipo I [@legendre_numerical_2012]. A figura obtida com o c√≥digo `msoplot(bird.rda)` demonstra que existe autocorrela√ß√£o espacial em algumas dist√¢ncias da an√°lise. Veja abaixo algumas alternativas para res√≠duos com autocorrela√ß√£o espacial.

### An√°lise de Redund√¢ncia parcial (RDAp)

Um dos problemas da abordagem anterior √© que tanto a composi√ß√£o de esp√©cies como as vari√°veis ambientais est√£o estruturadas espacialmente. Talvez mais importantes, para que os valores de probabilidade da RDA sejam interpretados corretamente (e para evitar Erro do Tipo I), os res√≠duos do modelo n√£o devem estar correlacionados espacialmente, como demonstrado com a an√°lise MSO. Uma alternativa √© incluir a matriz de dados espaciais (matrix W) como valor condicional dentro da RDA. Esta an√°lise √© conhecida como RDA parcial.

Por√©m, a obten√ß√£o dos dados espaciais da matriz W √© mais complexo do que simplesmente incluir dados de localiza√ß√£o geogr√°fica (latitude e longitude), como feito em alguns modelos lineares (e.g., *Generalized Least Squares* - GLS Cap√≠tulos \@ref(cap7) e \@ref(cap10)). Existem diversas ferramentas que descrevem e incorporam o componente espacial em m√©todos mulitidimensionais, mas os Mapas de Autovetores de Moran (MEM) s√£o certamente os mais utilizados [@dray_community_2012]. A an√°lise MEM consiste na ordena√ß√£o (PCoA) de uma matriz truncada obtida atrav√©s da localiza√ß√£o geogr√°fica das localidades utilizando dist√¢ncia euclidiana, matriz de conectividade e matriz espacial ponderada. Os autovalores obtidos no MEM s√£o id√™nticos aos coeficientes de correla√ß√£o espacial de Moran *I*. Um procedimento chave desta an√°lise √© a defini√ß√£o de um limiar de trucamento (do ingl√™s *truncate threshold*). Este limiar √© calculado a partir de uma "√°rvore de espa√ßo m√≠nimo" (*Minimum Spanning Tree* - MST) que conecta todos os pontos de coleta. Na pr√°tica, os valores menores do que o limiar definido pela MST indicam que os pontos com aqueles valores est√£o conectados e, assim possuem correla√ß√£o positiva. Outro ponto importante desta an√°lise √© a obten√ß√£o da matriz espacial ponderada (*Spatial Weighting Matrix* - SWM). A sele√ß√£o da matriz SWM √© parte essencial do c√°lculo dos MEM e n√£o deve ser feita arbitratiamente [@bauman_optimizing_2018]. Por este motivo, a an√°lise recebe este nome [@legendre_numerical_2012]. Finalmente, o m√©todo produz autovetores que representam preditores espaciais que podem ser utilizados na RDA parcial (e em outras an√°lises). √â importante ressaltar que o crit√©rio de sele√ß√£o do n√∫mero de autovetores √© bastante debatido na literatura e, para isso, sugerimos a leitura dos seguintes artigos: [@diniz-filho_spatial_2012, @bauman_optimizing_2018, @bauman_disentangling_2018].

Ent√£o, o primeiro passo para realizar uma RDA parcial √© de gerar os autovetores espaciais (MEMs).

```{r message=FALSE, warning=FALSE}
## Dados
# Matriz padronizada de composi√ß√£o de esp√©cies. 
head(species.hel)[, 1:6] 

## Latitude e longitude
head(xy)

## dados ambientais padronizados e altitude
head(env.pad.cat)

## Passo 1: Gerar um arquivo LIST W: list bin√°ria de vizinhan√ßa
mat_knn <- knearneigh(as.matrix(xy), k = 2, longlat = FALSE)
mat_nb <- knn2nb(mat_knn, sym = TRUE)
mat_listw <- nb2listw(mat_nb, style = "W")
mat_listw

## Passo 2: Listar os m√©todos "candidatos" para obter a matriz SWM
MEM_mat <- scores.listw(mat_listw, MEM.autocor = "positive")
candidates <- listw.candidates(xy, nb = c("gab", "mst", "dnear"), 
                               weights = c("binary", "flin"))

## Passo 3: Selecionar a melhor matriz SWM e executar o MEM
W_sel_mat <- listw.select(species.hel, candidates, MEM.autocor = "positive",
                          p.adjust = TRUE, method = "FWD")

## Passo 4: Matriz dos preditores espaciais escolhidos (MEMs)
spatial.pred <- as.data.frame(W_sel_mat$best$MEM.select)

## √â necess√°rio atribuir os nomes das linhas
rownames(spatial.pred) <- rownames(xy) 
```

Depois de gerar os valores dos autovetores espaciais (MEM), √© poss√≠vel executar a RDA parcial utilizando esses valores no argumento `Conditional`.

```{r message=FALSE, warning=FALSE}
## Combinar vari√°veis ambientais e espaciais em um √∫nico data.frame
pred.vars <- data.frame(env.pad.cat, spatial.pred)

## RDA parcial
rda.p <- rda(species.hel ~
                 rain.jul + maxi.jul + altitude + # Preditores ambientais
                 Condition(MEM1 + MEM2 + MEM4 + MEM5), # Preditores espaciais
             data = pred.vars)

## Interpreta√ß√£o
# Para interpretar, √© necess√°rio saber a signific√¢ncia dos eixos para representar a rela√ß√£o entre as vari√°veis preditoras e a composi√ß√£o de esp√©cies.
res.p.axis <- anova.cca(rda.p, by = "axis") 
res.p.axis

## Contribui√ß√£o
# Em seguida, √© poss√≠vel identificar quais s√£o as vari√°veis que contribuem ou que mais contribuem para a varia√ß√£o na composi√ß√£o de esp√©cies.
res.p.var <- anova.cca(rda.p, by = "term") ## Qual vari√°vel?
res.p.var
RsquareAdj(rda.p)
```

Se voc√™ comparar os resultados do objeto res.p.var (RDA parcial) com res.var (RDA simples) √© poss√≠vel perceber como a estrutura espacial nos res√≠duos aumenta a probabilidade de cometer Erro do Tipo I. O modelo da RDA parcial mostra que n√£o existem qualquer efeito direto das vari√°veis ambientais sobre a composi√ß√£o de esp√©cies (conclus√£o com a RDA simples). Na verdade, tanto a composi√ß√£o de esp√©cies quanto as vari√°veis clim√°ticas est√£o fortemente estruturadas no espa√ßo, como demonstramos a seguir.

```{r, tinytex.verbose = TRUE, cache = FALSE}
## Padr√£o espacial na composi√ß√£o de esp√©cies
pca.comp <- dudi.pca(species.hel, scale = FALSE, scannf = FALSE)
moran.comp <- moran.mc(pca.comp$li[, 1], mat_listw, 999)

## Padr√£o espacial das vari√°veis ambientais
env$altitude <- as.factor(env$altitude)
ca.env <- dudi.hillsmith(env, scannf = FALSE)
moran.env <- moran.mc(ca.env$li[, 1], mat_listw, 999)

## Estrutura espacial na composi√ß√£o de esp√©cies?
moran.comp

## Estrutura espacial na varia√ß√£o ambiental?
moran.env
```

Como resultado, √© poss√≠vel que a varia√ß√£o ambiental espacialmente estruturada √© o principal efeito sobre a composi√ß√£o de esp√©cies. Uma maneira de visualizar a contribui√ß√£o relativa de diferentes matrizes (ambiental e espacial, por exemplo) √© utilizar o m√©todo de parti√ß√£o de vari√¢ncia. O resultado deste modelo indica que, de fato, n√£o existe efeito direto das vari√°veis ambientais e sim do componente representado pela autocorrela√ß√£o espacial dessas vari√°veis (Figura \@ref(fig:fig-rda-parcial)).

```{r fig-rda-parcial, fig.cap="Diagrama de Venn mostrando a parti√ß√£o de vari√¢ncia da RDA.", message=FALSE, warning=FALSE}
## Triplot da RDA
# Parti√ß√£o de vari√¢ncia.
pv.birds <- varpart(species.hel, env.pad.cat, spatial.pred)
plot(pv.birds, cutoff = -Inf)
mtext("Diagrama de Venn: parti√ß√£o de vari√¢ncia")
```

### An√°lise de Redund√¢ncia baseada em dist√¢ncia (db-RDA)

Acima, apresentamos a an√°lise RDA que permite comparar, por exemplo, se vari√°veis ambientais determinam a varia√ß√£o na composi√ß√£o de esp√©cies. A RDA utiliza os dados brutos de composi√ß√£o de esp√©cies e √© baseada em uma PCA (i.e., requer dist√¢ncia euclidiana). Por√©m, em algumas situa√ß√µes √© necess√°rio utilizar outras medidas de dist√¢ncia tais como Bray-Curtis ou Gower. Esta analise √© bastante √∫til tamb√©m quando a matriz resposta j√° √© uma matriz de dist√¢ncia, tais como as que s√£o geradas por decomposi√ß√£o da diversidade beta. Neste caso, Legendre & Anderson [-@legendre_distance-based_1999] propuseram a an√°lise db-RDA (RDA baseada em dist√¢ncia). O primeiro passo da an√°lise √© gerar uma matriz de dist√¢ncia a partir da matriz bruta (e.g., composi√ß√£o de esp√©cies). Depois, a t√©cnica executa uma PCoA (corrigindo potenciais autovetores com autovalores negativos; ver discuss√£o acima) para comparar com os termos do modelo (matriz **X**, como na RDA). 
Para exemplificar como esta an√°lise pode ser implementada no R, vamos usar o mesmo exemplo demontrado na an√°lise RDA (ver acima). Por√©m, vamos fazer um ajuste sutil na pergunta "o clima e a altitude modificam a dissimilaridade (diversidade beta) de esp√©cies de aves?". Veja que neste caso, estamos perguntando diretamente sobre uma medida de diversidade beta, que ser√° calculada com o m√©todo Bray-Curtis. As vari√°veis preditoras ser√£o as mesmas obtidas no exemplo da RDA: `env.pad.cat`.   

**An√°lise**

```{r message=FALSE, warning=FALSE}
## Passo 1: transforma√ß√£o de hellinger da matriz de esp√©cies
# caso tenha dados de abund√¢ncia.
species.hel <- decostand(species, "hellinger")

## Passo 2: gerar matriz de dist√¢ncia (Diversidade beta: Bray-Curtis)
dbeta <- vegdist(species.hel, "bray")

## Passo 2: dbRDA 
dbrda.bird <- capscale (dbeta~rain.jul+maxi.jul+altitude, data=env.pad.cat)

# Para interpretar, √© necess√°rio saber a signific√¢ncia dos eixos para representar a rela√ß√£o entre as vari√°veis preditoras e a composi√ß√£o de esp√©cies
db.res.axis <- anova.cca(dbrda.bird, by = "axis") 
db.res.axis

# Em seguida, √© poss√≠vel identificar quais s√£o as vari√°veis que contribuem ou que mais contribuem para a varia√ß√£o na composi√ß√£o de esp√©cies 
db.res.var <- anova.cca(rda.bird, by = "term") ## Qual vari√°vel?
db.res.var

# Al√©m disso, √© poss√≠vel obter o valor do R2 do modelo
db_r_quadr <- RsquareAdj(dbrda.bird)
db_r_quadr
```

**Interpreta√ß√£o dos resultados**

Assim como apresentado na RDA, os resultados obtidos em `db.res.var` sugerem que as vari√°veis `rain.jul`, `maxi.jul` e `altitude` afetam a diversidade beta de aves. O valor do *R^2^* ajustado (0.495) sugere forte rela√ß√£o entre o gradiente ambiental e a diversidade beta. A compara√ß√£o entre o valor do `db_r_quadr` e `r_quadr` indica que a db-RDA teve melhor ajuste para comparar o mesmo conjunto de dados.

## PERMANOVA

A PERMANOVA √© uma sigla, em ingl√™s, de *Permutational Multivariate Analysis of Variance*, an√°lise proposta por Marti Anderson [@anderson_new_2001]. A PERMANOVA √© usada para testar hip√≥teses multivariadas que comparam a abund√¢ncia de diferentes esp√©cies em resposta a diferentes tratamentos ou gradientes ambientais. Essa an√°lise foi desenvolvida como forma de solucionar algumas limita√ß√µes da tradicional ANOVA multivariada (MANOVA). Em especial, o pressuposto da MANOVA de distribui√ß√£o normal multivariada √© raramente encontrado em dados ecol√≥gicos.

O primeiro passo da PERMANOVA √© selecionar uma medida de dist√¢ncia apropriada aos dados e, al√©m disso, verificar a necessidade de padroniza√ß√£o ou transforma√ß√£o dos dados. Em seguida, as dist√¢ncias s√£o comparadas entre os grupos de interesse (por exemplo, tratamento versus controle) usando a estat√≠stica *F* de maneira muito parecida com uma ANOVA (Cap√≠tulo \@ref(cap7)), chamada de *pseudo-F*:

$$F_pseudo = (SSa / SSr)*[(N-g) / (g-1)]$$

Nessa equa√ß√£o 

- *SSa* representa a soma dos quadrados entre grupos
- *SSr* a soma de quadrados dentro do grupo (residual) 
- *N* o n√∫mero de unidades amostrais
- *g* os grupos (ou n√≠veis da vari√°vel categ√≥rica)

Esta f√≥rmula do *pseudo-F* √© espec√≠fica para desenho experimental com um fator. Outros desenhos mais complexos s√£o apresetandos em Anderson [-@anderson_new_2001, -@anderson_permutational_2017]. O c√°lculo do valor de probilidade √© realizado por m√©todos de permuta√ß√£o que s√£o discutidos em Anderson & Ter Braak [-@anderson_permutation_2003].

**Exemplo 1**

Esp√©cies de aves que ocorrem em localidades com diferentes altitudes.

**Pergunta**

-   O clima e a altitude modificam a composi√ß√£o de esp√©cies de aves?

**Predi√ß√µes**

-   Diferen√ßas clim√°ticas (temperatura e chuva) e altitudinais alteram a composi√ß√£o de esp√©cies de aves

**Vari√°veis**

-   Preditoras: Temperatura e chuva (cont√≠nuas) e altitude (categ√≥rica com tr√™s n√≠veis)
-   Dependente: composi√ß√£o de esp√©cies de aves

```{r message=FALSE, warning=FALSE}
## Composi√ß√£o de esp√©cies padronizar com m√©todo de Hellinger
species.hel <- decostand(x = species, method = "hellinger")

## Matriz de dist√¢ncia com m√©todo Bray-Curtis
sps.dis <- vegdist(x = species.hel, method = "bray")
```

Para reduzir o n√∫mero de vari√°veis no modelo, voc√™ pode considerar duas abordangens. A primeira, e mais importante delas, √© manter somente vari√°veis preditoras que voc√™ tenha raz√£o biol√≥gica para mant√™-la e, al√©m disso, que esteja relacionada com suas hip√≥teses. Assim, uma vez que voc√™ j√° removeu vari√°veis que n√£o possuem relev√¢ncia biol√≥gica, voc√™ deve usar diferentes m√©todos para remover as vari√°veis muito correlacionadas (*forward selection*, *Variance Inflation Factor (VIF)*, entre outros). Neste exemplo, vamos simplesmente fazer uma correla√ß√£o m√∫ltipla e remover as vari√°veis com correla√ß√£o maior do que 0.9 ou -0.9. A fun√ß√£o `ggpairs()` mostra um gr√°fico bem did√°tico para representar a rela√ß√£o entre todas as vari√°veis e o valor (r) desta correla√ß√£o (mais em Cap√≠tulo \@ref(cap7)) (Figura \@ref(fig:fig-permanova-prev)).

```{r fig-permanova-prev, fig.cap="Correlograma mostrando a correla√ß√£o entre as vari√°veis.", message=FALSE, warning=FALSE}
## Verifica correla√ß√£o entre as vari√°veis
ggpairs(env) +
    tema_livro()

## Ap√≥s verificar a estrutura de correla√ß√£o, vamos manter somente tr√™s vari√°veis
env2 <- env[, c("mini.jan", "rain.tot", "altitude")]
```

Ap√≥s selecionar as vari√°veis do modelo, vamos executar a PERMANOVA e entender as principais etapas para interpretar corretamente o teste. A fun√ß√£o `adonis()` do pacote `vegan` √© uma boa op√ß√£o. Por√©m, √© importante referir o programa PRIMER e PERMANOVA+ como √≥tima op√ß√£o para implementar a PERMANOVA e ter maior controle em desenhos complexos [@anderson_permanova+_2008]. Assim como nos modelos lineares apresentados no Cap√≠tulo \@ref(cap7), os argumento seguem o mesmo formato, com vari√°vel dependente separada por um "~" das vari√°veis preditoras. Por√©m, alguns autores demonstraram que a PERMANOVA (assim como Mantel e ANOSIM) n√£o pode identificar se diferen√ßas significativas do teste (usando a estat√≠stica *pseudo-F*) se devem a diferen√ßas no posi√ß√£o, na dispers√£o ou ambos. Ou seja, ao comparar grupos n√£o √© poss√≠vel identificar se existe mudan√ßas de composi√ß√£o (posi√ß√£o) ou a varia√ß√£o da composi√ß√£o de esp√©cies dentro de um grupo (dispers√£o) √© maior do que a varia√ß√£o dentro do outro grupo [@anderson_permanova_2013]. Para solucionar este problema, √© poss√≠vel combinar a PERMANOVA com a an√°lise PERMDISP (ou BETADISPER, como chamado no pacote `vegan` implementado atrav√©s da fun√ß√£o `betadisper()`). Esta an√°lise permite comparar se existe heterogeneidade nas vari√¢ncias entre grupos. Deste modo, com a presen√ßa de heterogeneidade de vari√¢ncias (valor do BETADISPER significativo), √© poss√≠vel saber que as diferen√ßas entre os grupos ocorre principalmente por diferen√ßas na dispers√£o e n√£o, necessariamente, de posi√ß√£o. Mais detalhes sobre a relev√¢ncia de combinar essas duas an√°lises est√£o dispon√≠veis em Anderson & Walsh [-@anderson_permanova_2013].

```{r message=FALSE, warning=FALSE}
## PERMANOVA
perm.aves <- adonis2(sps.dis ~ mini.jan + rain.tot + altitude, data = env2)
perm.aves ### Diferen√ßas entre os tratamentos?

## BETADISPER
betad.aves <- betadisper(sps.dis, env2$altitude)
permutest(betad.aves)
```

Em nosso exemplo, a temperatura, precipita√ß√£o e altitude afetaram a varia√ß√£o na composi√ß√£o de esp√©cies. Por√©m, para identificar se as diferen√ßas de composi√ß√£o entre os n√≠veis da vari√°vel altitude, √© necess√°rio interpretar os resultados da an√°lise BETADISPER. O c√≥digo `permutest(betad.aves)` mostra que o valor de probabilidade da an√°lise foi de 0.253, ou seja, a hip√≥tese nula de que a vari√¢ncia entre grupos √© homog√™nea √© aceita. Assim, n√£o existe diferen√ßas na dispers√£o entre grupos, sugerindo que a diferen√ßa encontrada na PERMANOVA (objeto `perm.aves`) se deve, em parte, √† mudan√ßa na composi√ß√£o de esp√©cies de aves entre diferentes altitudes (R^2^ = 0.135). Al√©m disso, a precipita√ß√£o (R^2^ = 0.183) e temperatura (R^2^ = 0.127) foram fatores importantes na varia√ß√£o da composi√ß√£o de esp√©cies.

Como falado anteriormente, as an√°lises de ordena√ß√£o irrestritas (PCA, PCoA, nMDS) s√£o utilizadas para explorar dados. Uma maneira poderosa de us√°-las √© combinando com an√°lises que testam hip√≥teses, como PERMANOVA e RDA. A literatura ecol√≥gica tem usado a An√°lise de Escalonamento n√£o-M√©trico (*non-Metric Multidimensional Scaling* - nMDS) combinado com an√°lises multidimensionais de vari√¢ncia (como a PERMANOVA) para visualiza√ß√£o da similaridade na composi√ß√£o de esp√©cies dentro e entre grupos. A seguir, implementamos o nMDS na matriz de composi√ß√£o de esp√©cies de √°caros (Figura \@ref(fig:fig-nmds)).

```{r fig-nmds, fig.cap="Biplot mostrando o resultado do nMDS.", message=FALSE, warning=FALSE, }
## Matriz de dist√¢ncia representando a varia√ß√£o na composi√ß√£o de esp√©cies (m√©todo Bray-Curtis)
as.matrix(sps.dis)[1:6, 1:6]

## √â preciso calcular uma primeira "melhor" solu√ß√£o do nMDS
sol1 <- metaMDS(sps.dis)

## Melhor solu√ß√£o
# Depois, executar a mesma fun√ß√£o, mas utilizando uma "melhor solu√ß√£o inicial" para evitar resultdos sub√≥timos no nMDS .
nmds.beta <- metaMDS(sps.dis, previous.best = sol1)

## Stress
# O stress √© o valor mais importante para interpretar a qualidade da ordena√ß√£o.
nmds.beta$stress # valor ideal entre 0 e 0.2

## Exportar os valores para fazer gr√°fico 
dat.graf <- data.frame(vegan::scores(nmds.beta), altitude = env2$altitude)

## Definir os grupos ("HULL") para serem categorizados no gr√°fico 
grp.mon <- dat.graf[dat.graf$altitude == "Montanhoso", ][chull(dat.graf[dat.graf$altitude == "Montanhoso", c("NMDS1", "NMDS2")]), ]

grp.int <- dat.graf[dat.graf$altitude == "Intermedi√°rio", ][chull(dat.graf[dat.graf$altitude == "Intermedi√°rio", c("NMDS1", "NMDS2")]), ]

grp.pla <- dat.graf[dat.graf$altitude == "Plano", ][chull(dat.graf[dat.graf$altitude == "Plano", c("NMDS1", "NMDS2")]), ]

## Combinar dados dos grupos para cada Convex Hull
hull.data <- rbind(grp.mon, grp.int, grp.pla) 
head(hull.data)

## Gr√°fico
ggplot(dat.graf, aes(x = NMDS1, y = NMDS2, color = altitude, shape = altitude)) + 
    geom_point(size = 4, alpha = 0.7) + 
    geom_polygon(data = hull.data, aes(fill = altitude, group = altitude), alpha = 0.3) + 
    scale_color_manual(values = c("darkorange", "darkorchid", "cyan4")) +
    scale_fill_manual(values = c("darkorange", "darkorchid", "cyan4")) +
    labs(x = "NMDS1", y = "NMDS2") + 
    tema_livro()
```

## Mantel e Mantel parcial

O teste de Mantel se aplica quando temos duas ou mais matrizes de dist√¢ncia (triangulares). Em estudos ecol√≥gicos, essas matrizes normalmente descrevem dados de dist√¢ncia ou (dis)similaridade na composi√ß√£o de esp√©cies, dist√¢ncia geogr√°fica, e similaridade ambiental. Mas este teste tamb√©m √© amplamente aplicado na √°rea de gen√©tica de paisagem para testar hip√≥teses sobre como a composi√ß√£o gen√©tica de uma popula√ß√£o varia em fun√ß√£o do ambiente e/ou espa√ßo geogr√°fico [@legendre2010]. O teste nada mais √© do que uma generaliza√ß√£o do coeficiente de correla√ß√£o de Pearson (Cap√≠tulo \@ref(cap7)) para lidar com matrizes de dist√¢ncia. Como essas matrizes descrevem a rela√ß√£o entre v√°rios pares de locais, temos a repeti√ß√£o do mesmo local em outros pares. Neste caso √© preciso um procedimento semelhante ao de corre√ß√£o para m√∫ltiplos testes. 

J√° o Mantel parcial pretende testar a correla√ß√£o entre duas matrizes controlando para o efeito de uma terceira. Por exemplo, testar a associa√ß√£o entre a dissimilaridade na composi√ß√£o de esp√©cies e dissimilaridade ambiental, controlando para a dist√¢ncia geogr√°fica entre os locais. Isso nos permite levar em conta a poss√≠vel autocorrela√ß√£o espacial nas vari√°veis ambientais, ou seja, estar√≠amos testando de fato o efeito da dissimilaridade ambiental "pura" na dissimilaridae na composi√ß√£o de esp√©cies, evitando o efeito do espa√ßo em si. Portanto, note que sempre estamos raciocinando em termos de (dis)similaridade e n√£o dos dados brutos em si, seja composi√ß√£o de esp√©cies ou vari√°veis ambientais. √â importante ter isto em mente na hora de interpretar os resultados.

**Exemplo 1**

Neste exemplo, vamos utilizar um conjunto de dados que cont√©m girinos de esp√©cies de anf√≠bios anuros coletados em 14 po√ßas d'√°gua e os respectivos dados de vari√°veis ambientais destas mesmas po√ßas [@provete_broad-scale_2014].

**Pergunta**

-   Existe correla√ß√£o entre a dissimilaridade na composi√ß√£o de esp√©cies de girinos e a dissimilaridade ambiental?

**Predi√ß√µes**

-   Assumindo que processos baseados no nicho sejam predominantes, quanto mais diferentes as po√ßas forem maior ser√° a diferen√ßa na composi√ß√£o de esp√©cies

**Vari√°veis**

-   Vari√°veis: a matriz de dist√¢ncia (Bray-Curtis) da composi√ß√£o das esp√©cies e outra matriz de dist√¢ncia (Euclideana) das vari√°veis ambientais

**An√°lises**

Aqui vamos utilizar al√©m do conjunto de dados `bocaina` j√° conhecido, outras duas matrizes dispon√≠veis no pacote `ecodados`: `bocaina.xy` e `bocaina.env`, que cont√™m as coordenadas geogr√°ficas e vari√°veis ambientais das po√ßas, respectivamente.

```{r}
## Dados
head(bocaina.env)
head(bocaina.xy)

## Matriz de dist√¢ncia geogr√°fica
Dist.km <- as.dist(rdist.earth(bocaina.xy, miles=F)) # matriz de dist√¢ncia geogr√°fica (geod√©sica) considerando a curvatura da Terra

## Padroniza√ß√µes
comp.bo.pad <- decostand(t(bocaina), "hellinger")
env.bocaina <- decostand(bocaina.env[,-9], "standardize")

## Similaridades
simil.bocaina <- vegdist(comp.bo.pad, "bray")
simil.env <- vegdist(env.bocaina, "euclidian")
```

```{r}
## Mantel
# Espa√ßo vs. ambiente
mantel(Dist.km, simil.env) 

# Espa√ßo vs. composi√ß√£o
mantel(Dist.km, simil.bocaina) 

# Ambiente vs. composi√ß√£o
mantel(simil.env, simil.bocaina) 
```

Vamos agora fazer os gr√°ficos relacionando as matrizes de similaridade dos dados (Figura \@ref(fig:fig-mantel)).

```{r fig-mantel, fig.cap="Rela√ß√£o das matrizes de (dis)similaridade dos dados."}
## Dados
matrix.bocaina.env <- data.frame(x = melt(as.matrix(simil.bocaina))$value, 
                                 y = melt(as.matrix(simil.env))$value)

matrix.dist.env <- data.frame(x = melt(as.matrix(Dist.km))$value, 
                              y = melt(as.matrix(simil.env))$value)

matrix.dist.bocaina <- data.frame(x = melt(as.matrix(log(Dist.km)))$value, 
                              y = melt(as.matrix(log(1-simil.bocaina)))$value)

## Gr√°ficos
ggplot(matrix.bocaina.env, aes(x, y)) +
    geom_point() +
    labs(x = "Similaridade Bocaina", 
         y = "Similaridade Ambiental") +
    tema_livro()

ggplot(matrix.dist.env , aes(x, y)) +
    geom_point() +
    labs(x = "Dist√¢ncia geogr√°fica (km)", 
         y = "Similaridade Ambiental") +
    tema_livro()

ggplot(matrix.dist.bocaina , aes(x, y)) +
    geom_point() +
    labs(x = "Dist√¢ncia geogr√°fica (km)", 
         y = "Similaridade (Bray-Curtis)") +
    tema_livro()
```

**Interpreta√ß√£o dos resultados**

Os resultados mostraram que existe uma rela√ß√£o positiva, embora fraca, entre a dissimilaridade ambiental e a dissimilaridade na composi√ß√£o de esp√©cies. Este resultado est√° de acordo com a nossa hip√≥tese inicial. No entanto, vimos tamb√©m que existe uma rela√ß√£o positiva e significativa entre a dist√¢ncia em linha reta entre as po√ßas e a dissimilaridade ambiental. Logo, para de fato testar a rela√ß√£o entre o ambiente e a composi√ß√£o de esp√©cies temos de levar em conta o espa√ßo.

Para isto temos de realizar um teste de Mantel Parcial.

```{r}
## Mantel Parcial
mantel.partial(simil.bocaina, simil.env, Dist.km) #comp. vs. ambiente controlando o espa√ßo
```

Agora sim, vimos que a rela√ß√£o entre ambiente e esp√©cies se mant√©m, mas que a for√ßa dessa rela√ß√£o diminuiu bastante (veja o valor de r) quando controlamos o espa√ßo.

## Mantel espacial com modelo nulo restrito considerando autocorrela√ß√£o espacial

Embora seja um tipo de an√°lise bastante popular, o Mantel e a sua vers√£o parcial parecem n√£o ser muito adequadas para lidar com autocorrela√ß√£o espacial. Os autores dos artigos abaixo sugerem inclusive que esse tipo de an√°lise n√£o √© adequado para testar a maioria das hip√≥teses em Ecologia, incluindo diversidade beta. Esse √© um tema bastante discutido na literatura e n√£o vamos nos alongar muito sobre isso, mas referimos o(a) leitor(a) para os seguintes artigos chave: Legendre et al. 2015 [-@legendre2015], Legendre & Fortin 2010 [-@legendre2010], e Legendre [-@legendre2000].

No entanto, Crabot et al. [-@crabot2019] propuseram uma modifica√ß√£o no teste que leva em conta autocorrela√ß√£o espacial ao gerar o modelo nulo usado para o teste de hip√≥tese. √â utilizado um procedimento chamado *Moran Spectral Randomization* porque preserva a autocorrela√ß√£o global medida por meio do I de Moran global. A grande vantagem √© que este teste utiliza toda a flexibilidade dos *Moran Eigenvector Maps* (MEMs), que √© apresentado na parte de RDA, permitindo analisar rela√ß√µes entre as matrizes em m√∫ltiplas escalas espaciais. Vejamos como o teste funciona.

Primeiro precisamos construir um objeto com as duas matrizes que desejamos testar, no nosso caso composi√ß√£o de esp√©cies e espa√ßo. Depois precisamos construir explicitamente a nossa hip√≥tese de rela√ß√£o espacial entre os locais por meio de uma rede de vizinhan√ßa. Esta rede √© uma estrutura que nos dir√° como (e eventualmente com qual intensidade) se h√° rela√ß√£o entre os locais. Aqui, entende-se que nos referimos √† probabilidade de fluxo de indiv√≠duos entre os locais.

```{r}
## Mantel
compos_espac <- mantel.randtest(sqrt(simil.bocaina), Dist.km)
compos_espac
```

Note que at√© aqui n√£o h√° nada de novo, apenas utilizamos uma fun√ß√£o diferente para realizar o teste de Mantel, agora no pacote `ade4` ao inv√©s do `vegan`. Agora temos de construir a nossa rede de vizinhan√ßa. Optamos neste exemplo por uma rede bastante simples, que √© a *Minimum Spanning Tree*. Essa √© a rede espacial m√≠nima que mant√©m todos os pontos ligados entre si (Figura \@ref(fig:fig-mantel-espacial)).

```{r fig-mantel-espacial, fig.cap="Rede de vizinhan√ßa com a *Minimum Spanning Tree*"}
## Minimum Spanning Tree
nb.boc <- mst.nb(Dist.km) # calcula uma Minimum Spanning Tree
plot(nb.boc, bocaina.xy)
```

No gr√°fico, podemos ver a "cara" da rede. Cada ponto representa um local (po√ßa) e as linhas representam a liga√ß√£o hip√≥tetica entre eles, plotamos no espa√ßo geogr√°fico, ou seja, o Norte aponta pra cima. Agora temos apenas que converter o formato `nb` para `listw` e finalmente entrar com esses objetos na fun√ß√£o que realizar√° a an√°lise.

```{r}
## Convers√£o
lw <- nb2listw(nb.boc)

## Mantel espacial
msr(compos_espac, lw, method = "pair")
```

**Interpreta√ß√£o dos resultados**

Vamos comparar com o Mantel comum.

```{r}
## Mantel comum
compos_espac
```

Note que o valor da estat√≠stica do teste, ou seja, o r de Mantel √© exatamente o mesmo. No entanto, o valor de *P* que indicava que o teste havia sido significativo anteriormente mudou e passou a ser n√£o significativo. Isso ocorreu porque, embora a maneira de calcular a estat√≠stica do teste seja a mesma, a forma de construir a distribui√ß√£o nula, a partir da qual ser√° calculado o valor de *P* mudou drasticamente, resultando num teste n√£o significativo.

## PROCRUSTES e PROTEST

Uma alternativa ao Mantel para comparar o grau de associa√ß√£o entre conjuntos multidimensionais de dados (e.g., matriz de esp√©cies e matriz ambiental) √© a an√°lise conhecida como Procrustes [@gower_statistical_1971; @jackson_protest_1995]. Esta an√°lise compara duas matrizes (objetos nas linhas e vari√°veis nas colunas) minimizando a soma dos desvios quadrados entre os valores atrav√©s das seguintes t√©cnicas: transla√ß√£o, escalonamento e rota√ß√£o. √â importante notar que os objetos devem ser os mesmos e, desse modo, o n√∫mero de linhas √© obrigatoriamente igual, ao passo que o n√∫mero de colunas pode variar. A posi√ß√£o do objeto X~i~ (i = 1, ...n)  √© comparada com o objeto Y~i~ da matriz correspondente, movimentando os pontos via transla√ß√£o, reflex√£o, rota√ß√£o e dilata√ß√£o. Assim, os objetos da matriz X resultam na matrix X' que √© representada pelo melhor ajuste (menor valor residual da soma dos quadrados: estat√≠stica m~12~) entre a matriz X e Y. A estat√≠stica m~12~ mede, ent√£o, o grau de concord√¢ncia entre as duas matrizes. Os valores de m~12~ variam de 1 (sem concord√¢ncia) a 0 (m√°xima concord√¢ncia) [@peres-neto_how_2001; @lisboa_much_2014]. Para testar a signific√¢ncia do valor observado de m~12~, Jackson [-@jackson_protest_1995] sugeriu um teste de aleatoriza√ß√£o chamado PROTEST. 

As possibilidades de aplica√ß√£o do Procrustes para ecologia s√£o diversas. Dentre elas, se destacam a: i) morfometria geom√©trica e ii) ecologia de comunidades (concord√¢ncia de comunidades). Uma caracter√≠stica interessante do Procrustes √© a possibilidade de usar matriz bruta (e.g., vari√°veis ambientais) ou matriz de dist√¢ncia, o que amplia as possibilidades anal√≠ticas. Para compara√ß√µes com matrizes brutas, an√°lises de ordena√ß√£o irrestrita (PCA, CA) devem ser realizadas antes do Procrustes. Por outro lado, para compara√ß√µes com matrizes de dist√¢ncia (e.g., Euclidiana, Jaccard, Bray-Curtis), an√°lises como PCoA e nMDS devem preceder √† an√°lise de Procrustes [veja Figura 4 em @peres-neto_how_2001]. Nos dois casos, a ordena√ß√£o √© importante para gerar matrizes com a mesma dimensionalidade o que, por sua vez, permite comparar matrizes com n√∫mero de colunas diferentes.

**Exemplo 1**

Neste exemplo, vamos utilizar dois conjuntos de dados simulados de peixes e macroinvertebrados aqu√°ticos coletados em riachos. Neste exemplo hipot√©tico, existe uma rede de 12 riachos com diferentes graus de polui√ß√£o. Em cada riacho, foi produzida uma lista de esp√©cies de peixes e de macroinvertebrados (com dados de abund√¢ncia).

**Pergunta**

-   Existe concord√¢ncia na distribui√ß√£o na composi√ß√£o de esp√©cies de peixes e macroinvertebrados?

**Predi√ß√µes**

-   Assumindo que alguns poluentes, tais como metais pesados, podem atuar como filtro ambiental e limitar a ocorr√™ncia de determinados organismos aqu√°ticos, espera-se encontrar alta concord√¢ncia entre as duas matrizes (peixes e macroinvertebrados). Ou seja, a comunidade tanto de peixes quanto de macroinvertebrados responder√£o de forma similar ao gradiente ambiental

**Vari√°veis**

-   Vari√°veis: composi√ß√£o das esp√©cies de peixes e macroinverebrados aqu√°ticos

**An√°lises**

No exemplo escolhido, as duas matrizes representam a composi√ß√£o de esp√©cies em diferentes riachos. Desse modo, o ideal √© transformar esta matriz bruta em matriz de dist√¢ncia com o m√©todo Bray-Curtis (`vegdist()`). O pr√≥ximo passo, ent√£o, √© realizar uma `An√°lise de Coordenadas Principais (PCoA)` (veja abaixo) para gerar duas matrizes de ordena√ß√£o que ser√£o comparadas com a fun√ß√£o `procrustes()`. Por fim, utilizamos a fun√ß√£o `protest()` para testar a signific√¢ncia da concord√¢ncia entre as matrizes (Figura \@ref(fig:fig-procrustes)).

```{r fig-procrustes, fig.cap="Biplot mostrando o resultado da an√°lise de PROCRUSTES."}
## Dados
head(fish_comm)
head(macroinv)

## Fixar a amostragem
set.seed(1001) 

## Matrizes de dist√¢ncia de PCoA 
d_macro <- vegdist(macroinv, "bray")
pcoa_macro <- cmdscale(d_macro)

d_fish <- vegdist(fish_comm, "bray")
pcoa_fish <- cmdscale(d_fish)

## PROCRUSTES
concord <- procrustes(pcoa_macro, pcoa_fish)
protest(pcoa_macro, pcoa_fish)

## Gr√°fico
plot(concord, main = "", 
     xlab = "Dimens√£o 1",
     ylab = "Dimens√£o 2")
```

**Interpreta√ß√£o dos resultados**

A fun√ß√£o `protest()` apresenta dois resultados importantes: i) a estat√≠stica m~12~ e ii) o valor de signific√¢ncia (p). No exemplo, o valor de m~12~ √© igual a `0.6185` e o valor de p √© `0,019`. Desse modo, podemos concluir que existe concord√¢ncia entre a composi√ß√£o de esp√©cies de peixes e macroinvertebrados aqu√°ticos, sugerindo que o n√≠vel de polui√ß√£o pode gerar padr√µes previs√≠veis de distribui√ß√£o de diferentes organismos aqu√°ticos. A figura produzida pelo c√≥digo `plot(concord)` mostra um gr√°fico t√≠pico do Procrustes, onde a base da seta representa a matriz **X** e a ponta da seta a matriz alvo (**Y**) ap√≥s a rota√ß√£o para comparar o grau de concord√¢ncia entre **X** e **Y**. Cada ponto representa um objeto (linha) das matrizes **X** e **Y**. Quanto menor for o tamanho das setas, mais concordantes s√£o as observa√ß√µes em cada objeto.

## M√©todos multivariados baseados em modelos

Mais recentemente, alguns autores t√™m proposto m√©todos multivariados baseados em modelos. Estes m√©todos t√™m se diversificado hoje em dia e existem pacotes que realizam praticamente todas as an√°lises que vimos acima, com a diferen√ßa que utilizam distribui√ß√µes de probabilidade dado um modelo (e.g., Poisson) ao inv√©s de coeficientes de dissimilaridades. Vamos exemplificar o uso de um desses m√©todos, mas n√£o vamos fazer uma revis√£o extensiva. Caso o(a) leitor(a) deseje conhecer mais, recomendamos consultar principalmente os pacotes `gllvm`, `ecoCopula` e `Hmsc`.

Um dos primeiros m√©todos foi proposto em 2012 pelo grupo de David Warton [@warton2012], implementado no pacote `mvabund`. Anteriormente neste mesmo ano foi publicado um artigo pelo mesmo grupo [@wang2012] em que os autores demonstraram que m√©todos baseados em dissimilaridade, especialmente PERMANOVA, n√£o conseguem modelar adequadamente dados multivariados de contagem (e.g., abund√¢ncia) por n√£o levarem em conta a rela√ß√£o monot√¥nica entre m√©dia e vari√¢ncia. Vejamos o que isso quer dizer utilizando os dados do artigo de  da Silva et al. [-@dasilva2017] (Figura \@ref(fig:fig-media-var)).

```{r fig-media-var, fig.cap="Gr√°fico mostrando a m√©dia-vari√¢ncia para dados de abund√¢ncia multivariada."}
## Dados com seis primeiras localidades e esp√©cies
head(anuros_permanova)[1:6]
anuros_abund <- as.data.frame(anuros_permanova[,-28])#retirando a coluna que cont√©m o fator e deixando apenas dados de abund√¢ncia
grupos <- factor(anuros_permanova[,28])#incluindo apenas o fator a ser testado no modelo

## M√©dia-vari√¢ncia
abund_tr <- mvabund(anuros_abund) # criando um objeto da classe mvabund com os dados de abund√¢ncia
meanvar.plot(abund_tr)
```

Este conjunto de dados cont√©m abund√¢ncias de anf√≠bios coletados num conjunto de cidades do interior de S√£o Paulo e tamb√©m sua presen√ßa em museus. Aqui, vemos que h√° uma clara rela√ß√£o monot√¥nica entre a m√©dia e a vari√¢ncia da abund√¢ncia das esp√©cies na matriz. Ou seja, √† medida que esp√©cies aumentam sua m√©dia de abund√¢ncia, elas tamb√©m aumentam quase que proporcionalmente a sua vari√¢ncia. Esta √© uma propriedade bastante comum de dados multivariados de contagem, mas que n√£o √© muito bem modelada por m√©todos baseados em dissimilaridade, j√° que nesse caso apenas as esp√©cies mais abundantes t√™m de fato um peso na an√°lise.

A proposta implementada no pacote `mvabund` √© baseada em Modelos Lineares Generalizados (GLMs) que voc√™ j√° conhece do Cap√≠tulo \@ref(cap8). Ou seja, este m√©todo permite que sejam modeladas as abund√¢ncias das esp√©cies num contexto multivariado utilizando explicitamente distribui√ß√µes de probabilidade, tais como aquelas que utilizamos (e.g., Poisson, Binomial negativa, etc.). Isso faz com que demos peso semelhante √†s esp√©cies. Vejamos um exemplo de como o modelo √© ajustado e como √© feito teste de hip√≥tese.

**Exemplo 1**

A principal pergunta do artigo citado acima foi testar se a composi√ß√£o de esp√©cies que obtemos em campo e de cole√ß√£o cient√≠ficas √© diferente. Isso tem implica√ß√µes para levantamentos de fauna, j√° que podemos complementar um tipo de dado com outro ou saber se eles s√£o redundantes. Aqui, `grupos` √© apenas um fator que indica se aquela linha da matriz apresenta dados obtidos em campo ou cole√ß√£o. Vamos testar a hip√≥tese nula de que n√£o h√° diferen√ßa na composi√ß√£o entre as duas fontes de dados ajustando um modelo com Binomial negativa (Figura \@ref(fig:fig-mvabund)).

```{r fig-mvabund, fig.cap="Gr√°fico mostrando as abund√¢ncias para os dois grupos."}
## Gr√°fico
plot(abund_tr ~ grupos, cex.axis = 0.8, cex = 0.8)

## Modelo
modelo1 <- manyglm(abund_tr ~ grupos, family = "negative.binomial")
```

O gr√°fico mostrando os dados possui log da abund√¢ncia das esp√©cies e o fator (campo vs. cole√ß√£o). Com essa an√°lise explorat√≥ria de dados j√° podemos identificar se h√° diferen√ßa ou n√£o na abund√¢ncia das esp√©cies em cada local. Vemos que algumas esp√©cies s√£o bem mais abundantes no campo do que em cole√ß√µes, tais como *Leptodactylus mystacinus* e *Rhinella ornata*.

Uma grande vantagem desse tipo de m√©todo baseado em modelos √© que, assim como um GLM t√≠pico, tamb√©m podemos realizar diagnose dos res√≠duos utilizando plots de res√≠duos versus predito. Vejamos como isso funciona (Figura \@ref(fig:fig-mvabund-diag)).

```{r fig-mvabund-diag, fig.cap="Diagnose dos res√≠duos do modelo ajustado."}
## Diagnose
plot(modelo1)
```

Aqui vemos que os dados se distribuem de maneira mais ou menos homog√™nea e sem um padr√£o claro ao redor do zero. Isso indica que a distribui√ß√£o Binomial negativa foi adequada para modelar estes dados. E agora sim podemos interpretar os resultados com mais seguran√ßa.

**Interpreta√ß√£o dos resultados**

```{r}
## Resultados
summary(modelo1)
```

Aqui vemos que h√° sim uma diferen√ßa significativa na abund√¢ncia relativa das esp√©cies entre o campo e cole√ß√£o. Mas at√© ent√£o estamos levando em conta toda a matriz numa abordagem multivariada. No entanto, n√£o sabemos qual(is) esp√©cie(s) s√£o respons√°veis por este padr√£o. Para investigar isso, podemos realizar uma An√°lise de Deviance separada para cada esp√©cie, isso √© o que a linha abaixo faz.

```{r}
## ANOVA
anova(modelo1, p.uni = "adjusted")
```

Aqui vemos que algumas esp√©cies j√° identificadas no plot explorat√≥rio de fato s√£o importantes para determinar o padr√£o, tais como: *Leptodactylus mystacinus*, *Physalaemus nattereri* e *Rhinella ornata*. Essas foram esp√©cies cuja Deviance foi significativa.

## Para se aprofundar

### Livros
Listamos a seguir livros e artigos com material que recomendamos para seguir com sua aprendizagem em an√°lises multivariadas em R: i) Legendre & Legendre [-@legendre_numerical_2012] Numerical Ecology, ii) Borcard e colaboradores [-@borcard2018] Numerical Ecology with R, iii) Thioulouse e colaboradores [-@thioulouse_multivariate_2018] Multivariate Analysis of Ecological Data with ade4, iv) Ovaskainen & Abrego [-@ovaskainen_joint_2020] Joint Species Distribution Modelling, v) James & McCulloch [-@james_multivariate_1990] Multivariate Analysis in Ecology and Systematics: Panacea or Pandora's Box? e vi) Dunstan e colaboradores [-@dunstan_model_2011] Model based grouping of species across environmental gradients.

### Links

Existem alguns tutoriais online bem interessantes, mas todos em ingl√™s. Veja lista abaixo:

- [An√°lises de ordena√ß√£o - 1](https://www.davidzeleny.net/anadat-r/doku.php/en:ordination)
- [An√°lises de ordena√ß√£o - 2](http://ordination.okstate.edu/overview.htm)
- [Classifica√ß√£o num√©rica - agrupamento e kmeans](https://www.davidzeleny.net/anadat-r/doku.php/en:classification)

## Exerc√≠cios

**9.1**
Utilize os dados ‚Äúmite‚Äù do pacote vegan para testar o efeito de vari√°veis ambientais sobre a composi√ß√£o de esp√©cies de √°caros utilizando as seguintes an√°lises: RDA, RDAp (combinada com MEM), dbRDA e PERMANOVA. Ap√≥s realizar as cinco an√°lises, responda √†s seguintes perguntas?

A. Quais s√£o as vari√°veis ambientais (mite.env) mais importantes para a composi√ß√£o de √°caros em cada uma das an√°lises? 
B. Os vetores espaciais obtidos com a an√°lise MEM explicam a varia√ß√£o na composi√ß√£o de esp√©cies? Eles s√£o mais ou menos importantes do que as vari√°veis ambientais?
C. Discuta as diferen√ßas de interpreta√ß√£o entre a RDA, RDAp, dbRDA e PERMANOVA.

Dados necess√°rios:

```{r}
data(mite)
data(mite.env)
data(mite.xy)
```

**9.2**
Efetue uma an√°lise de agrupamento pela fun√ß√£o `hclust()`. Lembre-se de dar nome ao objeto para poder plotar o dendrograma depois. Utilize a ajuda para encontrar como entrar com os argumentos da fun√ß√£o. 

A) utilizando o m√©todo UPGMA e o √≠ndice de Bray-Curtis. 
B) Fa√ßa agora o dendrograma com outro √≠ndice de dissimilaridade e compare os resultados. S√£o diferentes? No que eles influenciar√≠am a interpreta√ß√£o do resultado?

**9.3**
Na perspectiva de metacomunidades (Leibold et al., 2004), a dispers√£o dos organismos tem um papel proeminente para entender como as esp√©cies est√£o distribu√≠das na natureza. Com o objetivo de testar se a dispers√£o influencia a composi√ß√£o de esp√©cies de clad√≥ceros e cop√©podos, e portanto a estrutura da metacomunidade, um pesquisador selecionou dois conjuntos de lagos: em um deles todos os lagos s√£o isolados e no outro os lagos s√£o conectados. 

A) Importe o conjunto de dados lagos do pacote `ecodados` e responda a pergunta se o fato de os lagos estarem conectados ou n√£o influencia a composi√ß√£o de esp√©cies desses microcrust√°ceos. Utilize m√©todos baseados em modelos que voc√™ aprendeu ao longo do cap√≠tulo para modelar a abund√¢ncia multivariada.

B) Fa√ßa um plot mostrando a abund√¢ncia relativa das esp√©cies com maior abund√¢ncia e veja se elas s√£o diferentes entre os tipos lagos. Combine este resultado com o do item anterior para interpretar o resultado final.

**9.4**
Carregue o pacote `MASS` para utilizar os dados `crabs`. Este conjunto traz medidas morfol√≥gicas de dois morfo-tipos da esp√©cie de carangueijo *Leptograpsus variegatus* coletada em Fremantle, Austr√°lia. Calcule uma PCA e veja se existe uma semelhan√ßa morfol√≥gica entre os dois morfo-tipos. Lembre-se de dar nome
ao objeto e use a fun√ß√£o `biplot()` para plotar o resultado do teste. Dica: a proje√ß√£o de um objeto perpendicular √† seta do descritor fornece a posi√ß√£o aproximada do objeto ao longo desse descritor. A dist√¢ncia dos objetos no espa√ßo cartesiano reflete a dist√¢ncia euclidiana entre eles.

[Solu√ß√µes dos exerc√≠cios](https://exercicios-livro-aer.netlify.app/cap.-9---an%C3%A1lises-multivariadas.html).