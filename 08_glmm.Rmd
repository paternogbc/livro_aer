# Cap. 8 - An√°lises univariadas (modelos lineares mistos generalizados) {#cap8}

### Pr√©-requisitos do cap√≠tulo {-}

```{r}
library(ecodados)
library(visdat)
library(tidyverse)
library(lattice)
library(RVAideMemoire)
library(DHARMa)
library(performance)
library(MuMIn)
library(piecewiseSEM)
library(MASS)
library(ggExtra)
library(sciplot)
library(emmeans) 
library(sjPlot)
library(bbmle)
library(glmmTMB)
library(ordinal)
library(car)
```

## Introdu√ß√£o

No cap√≠tulo anterior descrevemos sobre os modelos lineares (tamb√©m chamados de Modelos Lineares Gerais) que podem ser descritos pelo mesmo modelo matem√°tico de uma equa√ß√£o da reta do tipo::

> $$ Y = \beta_0 + \beta_{1}X_i + \epsilon_i $$

no qual o que difere uma regress√£o linear de uma an√°lise de vari√¢ncia √© a natureza do elemento x~i~, vari√°vel cont√≠nua para regress√£o, vari√°vel categ√≥rica no caso da ANOVA (que √© codificada numa matriz *design* para desenhos mais complexos). Nesse sentido, o que todos esses m√©todos t√™m em comum √© a vari√°vel resposta Y que √© um vetor num√©rico cont√≠nuo. Outro elemento em comum desses m√©todos √© a distribui√ß√£o de frequ√™ncia do erro. Se quiser mais detalhes como sobre modelos lineares podem ser escritos na forma de matrizes, consulte a introdu√ß√£o de (@ecologic2015). Todos os modelos lineares assumem que a distribui√ß√£o do erro seja Gaussiana (ou Normal). Isso de certa forma limita o tipo de dado que pode ser usado como vari√°vel resposta por estas an√°lises. Por exemplo, dados de contagem (e.g., riqueza e abund√¢ncia de esp√©cies), frequ√™ncia (e.g., frequ√™ncia de ocorr√™ncia, porcentagem de cobertura vegetal), incid√™ncia (e.g., presen√ßa ou aus√™ncia de uma esp√©cie) ou propor√ß√£o (e.g., n√∫meros de animais infectados a cada 1000 animais) n√£o s√£o adequados para serem utilizados como vari√°veis resposta em modelos lineares. Uma pr√°tica comum quando nossos dados n√£o s√£o Normais √© transformar por log ou raiz quadrada. No entanto, para dados de contagem isso n√£o √© recomendado - veja O'Hara & Kotze [-@ohara2010], Ives [-@ives2015] e Warton [-@warton2018] para mais detalhes.

Nestes casos devemos recorrer a um conjunto de modelos chamados Modelos Lineares Generalizados (GLM). Nestes modelos, o usu√°rio especifica a distribui√ß√£o de frequ√™ncia que deseja utilizar para modelar a vari√°vel resposta. Esta distribui√ß√£o de frequ√™ncia deve pertencer √† fam√≠lia exponencial, que inclui a distribui√ß√£o de Poisson, Gaussiana, Binomial, Binomial Negativa, Gamma, Bernoulli e Beta. Ainda √© poss√≠vel utilizar Cumulative Link Models para modelar dados ordinais (fatores cuja ordem dos elementos importa, tais como muito baixo, baixo, alto e muito alto). Abaixo vamos ver um pouco sobre como um GLM funciona e exemplos com cada uma destas distribui√ß√µes.

## Como um GLM funciona?

Diferentemente do modelo linear, um GLM estima os par√¢metros por meio de M√°xima Verossimilhan√ßa (ML) ao inv√©s dos m√≠nimos quadrados comuns (OLS).

Portanto, um GLM relaciona a **distribui√ß√£o da vari√°vel resposta** aos **preditores lineares** por meio de uma **fun√ß√£o de liga√ß√£o**. Por exemplo, no caso da distribui√ß√£o de Poisson usa-se uma liga√ß√£o logar√≠tmica (tamb√©m chamada de log link) que garante que o valores ajustados s√£o sempre n√£o negativos. Portanto, um GLM √© composto por esses 3 componentes: fun√ß√£o de distribui√ß√£o, preditor linear e fun√ß√£o de liga√ß√£o. A fun√ß√£o de distribui√ß√£o √© uma hip√≥tese sobre a distribui√ß√£o da vari√°vel resposta Y~i~. Isso tamb√©m define a m√©dia e a vari√¢ncia de Y~i~. J√° a fun√ß√£o de liga√ß√£o define a rela√ß√£o entre o valor m√©dio de Y~i~ e da parte sistem√°tica. Esta √© tamb√©m chamada de liga√ß√£o entre a m√©dia e a parte sistem√°tica do modelo. Existem tr√™s tipos de fun√ß√£o de liga√ß√£o:

‚Ä¢**Identity link**, que √© definido por g(¬µ)= Œº, e modela a m√©dia ou valor esperado de Y. Usado em modelos lineares padr√£o.

‚Ä¢**Log link**, que √© g(Œº)=log(Œº), e modela o log da m√©dia. √â usado para dados de contagem (que n√£o podem assumir valores negativos) em modelos log-linear

‚Ä¢**Logit link**, que √© g(Œº)=log[Œº /(1-Œº )], e √© usado para dados bin√°rios e regress√£o log√≠stica

Logo, um modelo linear pode ser visto como um caso particular de um GLM em que utiliza distribui√ß√£o Gaussiana, com identity link

## Como escolher a distribui√ß√£o correta para seus dados?

### Para dados cont√≠nuos

Se Y √© uma vari√°vel cont√≠nua, a sua distribui√ß√£o de probabilidade deve ser normal. Nesses casos as distribui√ß√µes recomendadas s√£o a **Gaussiana (Normal) ou Gamma**. Para essas distribui√ß√µes, o par√¢metro de dispers√£o √© estimado separadamente da m√©dia e √© √†s vezes, chamado de *nuisance parameter*. Uma particularidade da distribui√ß√£o Gamma √© que ela s√≥ aceita valores cont√≠nuos positivos.

### Para dados de contagem

Se Y √© bin√°rio (e.g., vivo ou morto), a distribui√ß√£o de probabilidade deve ser **binomial**.

Se Y √© uma contagem (e.g., abund√¢ncia ou riqueza de esp√©cies), ent√£o a distribui√ß√£o de probabilidade deve ser **Poisson ou Binomial Negativa**. Existem tamb√©m corre√ß√µes dessas distribui√ß√µes quando apresentam sobredispers√£o (*overdispersion*), tais como quasi-Poisson ou quasi-Negative binomial. Falaremos delas no momento certo.

Para distribui√ß√µes tais como binomial e Poisson, a vari√¢ncia deve ser igual √† media e o par√¢metro de dispers√£o √© sempre 1. Na maioria dos dados ecol√≥gicos esse pressuposto n√£o √© cumprido, veremos estrat√©gias para lidar com isso logo √† frente.

As fun√ß√µes `Ord_plot` e `goodfit` do pacote `vcd` podem auxiliar na escolha da distribui√ß√£o para dados de contagem.

## Dados de contagem: a distribui√ß√£o de Poisson

Para casos em que estamos interessados em quantificar uma vari√°vel discreta, ou seja, uma vari√°vel positiva, representada sempre por n√∫meros inteiros, contendo um n√∫mero finito de possibilidades, devemos utilizar a **distribui√ß√£o de Poisson**. Esta distribui√ß√£o √© peculiar por ser descrita apenas por um par√¢metro livre ($\lambda$). Isso quer dizer que tanto a m√©dia quanto a vari√¢ncia dos dados s√£o descritos por um √∫nico par√¢metro, o que implica em dizer que a m√©dia e a vari√¢ncia t√™m de ser iguais.

Vamos ver um exemplo com dados reais.

#### Exemplo 1

**Explica√ß√£o dos dados**

Neste exemplo iremos utilizar dados de riqueza de anf√≠bios anuros coletados em 40 po√ßas, a√ßudes e brejos ao redor de fragmentos florestais no Noroeste Paulista [@prado2014]. Os autores mediram seis vari√°veis em escala local e outras tr√™s em escala de paisagem.

**Pergunta**

A dist√¢ncia linear para o corpo d'√°gua mais pr√≥ximo influencia a abund√¢ncia total de esp√©cies de anuros?

**Predi√ß√µes**

Corpos d'√°gua mais conectados permitem que indiv√≠duos dispersem entre eles com maior facilidade, suportando melhor din√¢micas de metapopula√ß√µes. Portanto, espero que po√ßas que estejam mais conectadas entre si tenham maior riqueza total de sapos.

**Vari√°veis**

‚Ä¢ Vari√°vel reposta: riqueza de sapos em 40 po√ßas. ‚Ä¢ Vari√°vel preditora: dist√¢ncia da po√ßa focal para a mais pr√≥xima na escala da paisagem

**Checklist**

‚Ä¢ Verificar se o seu dataframe est√° com as unidades amostrais nas linhas (neste caso po√ßas) e vari√°veis nas colunas.

Antes de come√ßar com a an√°lise, vamos primeiro explorar os dados.

```{r out.width="49%"}
head(fragmentos)
glimpse(fragmentos)
```

Percebam que o data frame cont√©m 40 colunas. Neste conjunto de dados as vari√°veis preditoras j√° est√£o padronizadas com m√©dia 0 e desvio padr√£o 1. As vari√°veis com "2" indicam vari√°veis quadr√°ticas (podem ser usadas para se testar rela√ß√µes n√£o lineares). Tamb√©m temos a riqueza observada e a estimada (`Riqueza_HB`) e as coordenadas geogr√°ficas (X e Y). Vamos agora explorar os dados e ver como √© a rela√ß√£o entre riqueza e dist√¢ncia para a po√ßa mais pr√≥xima. Sempre √© recomendado visualizar os dados antes de efetivamente os modelar para se ter uma id√©ia da rela√ß√£o entre as vari√°veis:

```{r}
# -------------------------------------------------------------------------
ggplot(fragmentos, aes(dfrag, Riqueza_obs))+
       geom_point(size=4, alpha = 0.7)+
       stat_smooth(method = "lm")
```

Aqui vemos que h√° de fato uma rela√ß√£o linear positiva entre as duas vari√°veis.

> A partir de agora vamos sempre usar uma mesma estrutura para realizar nossos exerc√≠cios de modelagem:

1.  Primeiro vamos especificar o modelo;
2.  Depois realizar a diagnose;
3.  Por √∫ltimo realizar infer√™ncia a partir do nosso modelo.

##### Modelagem

O primeiro argumento da fun√ß√£o `glm`√© uma f√≥rmula, em que na parte esquerda temos a vari√°vel resposta seguida do s√≠mbolo `~` (l√™-se: modelado em fun√ß√£o de) seguido pelas vari√°veis preditoras. Aqui podemos usar uma ou mais vari√°veis e testar o seu efeito aditivo (usando o sinal de +) ou a intera√ß√£o entre elas (usando o sinal de \*). Um bom resumo sobre como especificar o seu modelo pode ser encontrada [aqui neste blog](https://ridiculas.wordpress.com/2012/07/23/semantica-para-descrever-modelos/). Aqui optamos por um modelo bem simples modelando a riqueza de anf√≠bios apenas em fun√ß√£o da dist√¢ncia para o fragmento mais pr√≥ximo.

```{r}
mod_pois <- glm(Riqueza_obs~dfrag, family = poisson(link = "log"), data = fragmentos)
```

Assim como modelos lineares que vimos no Cap√≠tulo 6, GLMs com distribui√ß√£o de Poisson requerem que se teste os pressupostos, incluindo sobredispers√£o e infla√ß√£o de zeros.

##### Diagnose b√°sica dos res√≠duos do modelo

Iremos realizar tr√™s diagnoses b√°sicas dos GLMs, avaliando diferentes aspectos do modelo:

1.  Heterogeneidade da vari√¢ncia e normalidade dos res√≠duos

2.  Sobredispers√£o (*Overdispersion*)

3.  Infla√ß√£o de zeros (*Zero-inflation*)

Vamos come√ßar avaliando as heterogeneidade da vari√¢ncia e normalidade dos res√≠duos:

```{r}
plotresid(mod_pois, shapiro = TRUE)#S√ì O PLOT DE RES√çDUOS
par(mfrow=c(2,2))
plot(mod_pois)#TODOS OS 4 PLOTS
par(mfrow=c(1,1))
```

Vemos que as linhas vermelhas (que indicam a tend√™ncia dos dados) est√£o praticamente retas seguindo a linha pontilhada, sugerindo que n√£o exista heterogeneidade de vari√¢ncia dos res√≠duos. Vemos tamb√©m que nos quatro plots alguns dados, 1, 7 e 30 (referem-se √†s linhas do data.frame) aparecem identificados, pois apresentam ligeiro desvio da normalidade e est√£o distantes da m√©dia. No entanto, n√£o √© algo para nos preocuparmos pois n√£o s√£o valores muito extremos. Portanto, a diagnose indicou que o modelo com Poisson parece ser adequado para modelar estes dados, ao menos em termos de homogeneidade de vari√¢ncia.

##### Diagnose avan√ßada

Alguns pacotes permitem calcular outros aspectos do modelo que facilitam a diagnose, ou seja, se podemos de fato confiar nos par√¢metros estimados por eles, incluindo valores de signific√¢ncia. Um pressuposto importante dos modelos de contagem (incluindo Poisson) √© a *overdispersion*.

Vejamos como o pacote `DHARMa` funciona:

```{r}
simulationOutput <- simulateResiduals(fittedModel = mod_pois, plot = TRUE)
```

O plot claramente indica que h√° problema com *overdispersion*, mas n√£o em termos de desvios de normalidade (KS test) ou outlier, j√° que apenas o primeiro foi significativo (aparece em vermelho).

##### Detectando e lidando com overdispersion

O que √© sobredispers√£o (*overdispersion*)? Ela ocorre quando a vari√¢ncia observada √© muito maior do que aquela predita pelo modelo. Para modelos que utilizam a distribui√ß√£o de Poisson, isso ocorre quando a vari√¢ncia aumenta com a m√©dia. Lembre-se de que esta distribui√ß√£o tem apenas um √∫nico par√¢metro para descrever tanto a m√©dia quanto a vari√¢ncia ($\lambda$). Portanto, a vari√¢ncia tem de ser igual √† m√©dia. No entanto, se a vari√¢ncia nos dados observados for muito maior do que a m√©dia, dizemos que h√° sobredispers√£o nos dados.

Existem duas formas de diagnosticar *overdispersion* que est√£o implementadas na maioria dos pacotes. Aqui vamos demonstr√°-las usando as fun√ß√µes `check_overdispersion` e `testDispersion` dispon√≠veis nos pacotes `performance` e `DHARMa`, respectivamente.

A fun√ß√£o `testDispersion` do `DHARMa` utiliza um m√©todo de aleatoriza√ß√£o dos res√≠duos para determinar se h√° *overdispersion* nos dados, cuja vantagem √© que aborda diretamente a varia√ß√£o nos dados, ao inv√©s de medir o ajuste do modelo em si, com outros testes.

```{r}
par(mfrow=c(1,1))
testDispersion(mod_pois)#modelo tem overdispersion
```

Aqui temos um gr√°fico e o resultado novamente do teste de *overdispersion* (que j√° aparecia no gr√°fico anterior) mostrando que de fato h√° *overdispersion*: perceba que o valor de *P* √© significativo. O gr√°fico nos mostra em preto a distribui√ß√£o dos res√≠duos aleatorizados e a linha vermelha o valor observado da estat√≠stica. J√° que a linha est√° bem √† direita da distribui√ß√£o, isso indica *overdispersion*, se estivese √† esquerda seria o caso de *underdispersion*.

Agora vamos utilizar a fun√ß√£o `check_overdisperion` que utiliza uma distribui√ß√£o qui-quadradado e o valor de *dispersion ratio* para testar a presen√ßa de *overdispersion* no modelo. Esse teste tamb√©m pode ser feito com a fun√ß√£o acima ao se especificar o argumento `type="PearsonChisq"`

```{r}
check_overdispersion(mod_pois)#modelo tem overdispersion
```

Quando este resultado √© significativo, como vimos na √∫ltima linha acima, isso indica *overdispersion*.

```{r}
summary(mod_pois)
```

Na parte de baixo do output da fun√ß√£o `summary` tamb√©m podemos calcular o *dispersion parameter* dividindo o *residual deviance* pelos graus de liberdade dos res√≠duos. Esta √© outra maneira f√°cil e r√°pida de detectar *overdispersion*. Neste exemplo temos que *Dispersion parameter* = `r (chat <- deviance(mod_pois) / df.residual(mod_pois))`. Quando esse valor √© pr√≥ximo de 1 isso sugere que n√£o h√° *overdispersion*. No entanto, se ele for maior que 1.5 isso sugere que o modelo sofre de *overdispersion* e que devemos usar outra distribui√ß√£o, tal como a distribui√ß√£o binomial negativa.

Al√©m disso, uma outra forma de diagnosticar o modelo √© calcular os res√≠duos de Pearson (res√≠duos normalizados), que √© basicamente a raiz quadrada da vari√¢ncia da vari√°vel resposta.

##### Infla√ß√£o de zeros

Qualquer das formas mostradas acima de diagnosticar overdispersion pode ser usada na maioria das vezes, com exce√ß√£o de dados com muitos zeros (pouca vari√¢ncia). Por isso devemos tamb√©m testar se o nosso modelo sofre de infla√ß√£o de zeros. Vejamos como isso funciona usando as fun√ß√µes `check_zeroinflation` no pacote `performanace` e `testZeroInflation` no pacote `DHARMa`:

```{r}
check_zeroinflation(mod_pois) # para diagnosticar se o modelo sofre de zero inflation
```

e no `DHARMa`

```{r}
testZeroInflation(mod_pois) # para testar se existe zero inflation
```

Tanto a fun√ß√£o do `DHARMa` quanto do `performance` conseguiram detectar que o modelo tem problemas com *overdispersion*, mas isso n√£o √© causado pelo excesso de zeros. Como j√° dissemos acima, no caso da distribui√ß√£o Poisson, tanto a m√©dia quanto a vari√¢ncia s√£o modeladas pelo mesmo par√¢metro ($\lambda$). Isso faz com que esta distribui√ß√£o n√£o seja muito √∫til para modelar dados de contagem em que haja muita vari√¢ncia em torno da m√©dia. Esse infelizmente √© o caso da grande maioria dos dados ecol√≥gicos.

Por estes motivos n√£o podemos fazer infer√™ncia com este modelo porque os par√¢metros estimados n√£o s√£o confi√°veis. Mas vejamos como seria feita essa infer√™ncia *caso este modelo fosse adequado*.

##### Infer√™ncia

Aqui iremos apresentar v√°rias fun√ß√µes para calcular o coeficiente de determina√ß√£o (R^2^). No caso de GLM(M)s, n√£o h√° um consenso sobre como se calcula este coeficiente, havendo v√°rias propostas que utilizam maneiras diferentes de estimar a heterogeneidade de vari√¢ncia e covari√¢ncia entre observa√ß√µes dos res√≠duos, veja [@nakagawa2017] e [@ives2015] para maiores detalhes, assim como o *help* das respectivas fun√ß√µes.

```{r}
## Coeficientes estimados pelo modelo
summary(mod_pois)

## Calculando o R2 do modelo
r.squaredGLMM(mod_pois)
rsquared(mod_pois)
r2(mod_pois)
```

Podemos ver que os valores de R^2^ s√£o bem baixos (em torno de 4 - 5%), independente do m√©todo que usamos pra calcul√°-lo.

##### Plot do modelo predito

```{r}
a1 <- ggplot(fragmentos, aes(dfrag, Riqueza_obs))+
       geom_point(cex = 4,alpha = 0.7)+
       geom_smooth(method = "glm", formula = y~x, method.args = list(family ="poisson"), se=TRUE)+
  labs(x="Dist√¢ncia para o fragmento mais pr√≥ximo", y="Riqueza observada")

ggMarginal(a1, fill="red")
```

::: {.alert .alert-info}
<strong> üìù Importante </strong>\
Aqui vemos que h√° uma leve tend√™ncia na rela√ß√£o positiva entre dist√¢ncia para o fragmento mais pr√≥ximo e a riqueza de anf√≠bios observada. No entanto, h√° uma grande dispers√£o nos dados ao redor da reta do modelo, fazendo com que a rela√ß√£o n√£o seja de fato significativa e tenhamos um R^2^ bem baixo.
Caso pud√©ssemos confiar nos par√¢metros deste modelo poder√≠amos dizer que existe uma leve tend√™ncia a um aumento da riqueza observada de anf√≠bios anuros √† medida que aumenta a dist√¢ncia da po√ßa para o fragmento mais pr√≥ximo. 
:::

### O que causa a *overdispersion*?

Existem dois conjuntos de causas: aparente ou real. 

> As causas aparentes s√£o geradas pela *m√° especifica√ß√£o do modelo*, tais como:
>
> - 1. n√£o inclus√£o de covari√°veis ou intera√ß√µes no modelo;

> - 2.  presen√ßa de outliers na vari√°vel resposta, efeitos n√£o lineares da covari√°vel (X2, X3...);

> - 3.  escolha errada da fun√ß√£o de liga√ß√£o (link function).


> As causas reais incluem:
>
> - 1.  vari√¢ncia maior que a m√©dia;

> - 2.  muitos zeros;

> - 3.  agrega√ß√£o de observa√ß√µes;

> - 4.  correla√ß√£o entre observa√ß√µes (n√£o independ√™ncia).

### O que fazer se seu modelo tiver *overdispersion*?

Depois de tentar corrigir poss√≠veis m√°s especifica√ß√µes, como as listadas acima, existem duas alternativas:

1.  usar outra distribui√ß√£o, tal como Binomial negativa caso o *dispersion parameter* seja maior que 15 ou 20; ou

2.  Usar um modelo com corre√ß√£o de erro da sobredispers√£o, caso 1.5 \< *dispersion* \> 15.

Geralmente, dados de contagem em estudos ecol√≥gicos n√£o seguem uma distribui√ß√£o Poisson, pois h√° muita dispers√£o (vari√¢ncia) nos dados. Logo, o pressuposto da distribui√ß√£o Poisson, i.e., de que a m√©dia e vari√¢ncia s√£o descritas por um mesmo par√¢metro ($\lambda$) √© quebrado.

Como vimos, *overdispersion* √© um problema comum ao analisar dados ecol√≥gicos e deve necessariamente ser diagnosticado no modelo. Uma maneira de lidar com esse tipo de problema √© utilizar uma outra distribui√ß√£o diferente da Poisson. A binomial negativa pode ser entendida como uma mistura da distibui√ß√£o Poisson e Gamma, ou seja, ela aceita dados de contagem que sejam positivos, mas sem zero. A grande vantagem desta distribui√ß√£o √© que, diferentemente da Poisson, ela tem um par√¢metro para modelar a m√©dia ($\lambda$) e outro para modelar a vari√¢ncia (*k*). Logo, ela permite modelar dados em que a m√©dia √© diferente da vari√¢ncia. Vejamos um exemplo.

Aqui vamos continuar com estes dados para ver como o modelo se comporta com essa nova distribui√ß√£o especificada. Para isso vamos utilizar a fun√ß√£o `glm.nb` do pacote `MASS`:

#### Modelagem

```{r}
mod_nb <- glm.nb(Riqueza_obs~dfrag, data = fragmentos)
```

##### Diagnose res√≠duos

Assim como fizemos com o modelo com Poisson, vamos agora diagnosticar os res√≠duos:

```{r}
par(mfrow=c(2,2))
plot(mod_nb)
par(mfrow=c(1,1))
(chat <- deviance(mod_nb) / df.residual(mod_nb))#DISPERSION PARAMETER
```

Compare estes gr√°ficos com os do modelo anterior com distribui√ß√£o Poisson. Eles s√£o praticamente id√™nticos, ou seja, o modelo com Poisson j√° n√£o tinha heterogeneidade de vari√¢ncia nem problemas com normalidade dos res√≠duos. Agora vejamos se o problema com *overdispersion* foi resolvido:

```{r}
simulationOutput <- simulateResiduals(fittedModel = mod_nb, plot = TRUE)
```

Na diagnose do modelo pelo `DHARMa` vemos que bastou mudar a distribui√ß√£o de probabilidade que o problema de *overdispersion* foi resolvido (nenhum teste foi significativo no quadro da esquerda), e como j√° sab√≠amos, n√£o h√° problemas com heterogeneidade de vari√¢ncia (plot da direita mostrando a tend√™ncia entre o predito e res√≠duos pra cada quantil), nem de outliers. O *dispersion parameter* √© mais pr√≥ximo de 1 do que no modelo com Poisson. Agora sim podemos levar em conta o R^2^ ...

##### Infer√™ncia

```{r}
rsquared(mod_nb)
```

...que parece um pouco menor do que anteriormente. Perceba que aqui utilizamos somente uma das fun√ß√µes apresentadas anteriormente, j√° que se trata de um modelo GLM com binomial negativa, calculamos o R^2^ pelo m√©todo de Nagelkerke.

##### Interpreta√ß√£o dos resultados

```{r message=FALSE, warning=FALSE}
summary(mod_nb)
```

::: {.alert .alert-info}
<strong> üìù Importante </strong>\
Aqui vemos que o resultado em termos de valor de _P_ n√£o mudou, ou seja, a dist√¢ncia par ao fragmento mais pr√≥ximo n√£o foi significativo. Mas vejam que o coeficiente (slope) mudou um pouco, antes era 0.0718 (SE=0.0507) e com binomial negativa passa a ser 0.07248  (SE=0.06571).
:::

##### Plot do modelo predito

```{r}
ggplot(fragmentos, aes(dfrag, Riqueza_obs))+
       geom_point(size=4, alpha=0.7)+
       geom_smooth(method = "glm.nb", formula = y~x, se=TRUE)+
  labs(x="Dist√¢ncia para o fragmento mais pr√≥ximo", y="Riqueza observada")
```

Aqui vemos que a reta predita pelo modelo √© muito similar ao que tivemos com o Poisson. No entanto, agora que sabemos que este modelo com binomial negativa foi corretamente especificado e podemos confiar nos par√¢metros estimados.

## Dados de contagem: modelos quasi-likelihood

Como dissemos acima, uma outra alternativa para ajustar modelos GLM a dados de contagem s√£o os chamados "quasi-likelihood", tais como quasi-Poisson e quasi-binomial. Dependendo do valor do dispersion parameter, pode ser √∫til escolher este tipo de modelo. No entanto, eles v√™m com uma desvantagem: n√£o √© poss√≠vel calcular o valor de *Akaike Information Criterion* (AIC) porque estes modelos n√£o retornam um valor de *likelihood* (verosimilhan√ßa). Este par√¢metro √© comumente utilizado em abordagens estat√≠sticas de teoria da informa√ß√£o para selecionar o melhor modelo que se ajusta aos dados. Neste caso, precisamos utilizar outras fun√ß√µes dispon√≠veis nos pacotes `MuMIn`, `AICcmodavg`, e `bbmle` para calcular o QAIC. Para mais detalhes sobre esses modelos, veja o vignette sobre o assunto do pacote `bbmle`.

#### An√°lise

Aqui vamos apenas exemplificar como um modelo com distribui√ß√£o quasi-poisson pode ser especificado.

```{r}
mod_quasipois <- glm(Riqueza_obs~dfrag, family = quasipoisson(link = "log"), data = fragmentos)
```

##### Diagnose dos res√≠duos

A fun√ß√£o `resid` n√£o leva em conta a sobredispers√£o e temos de calcular manualmente o par√¢metro de dispers√£o e inclui-lo no plot. Portanto, n√£o podemos realizar a diagnose de modelos quasi-Poisson apenas com a fun√ß√£o `plot` como faz√≠amos at√© ent√£o. Ent√£o, calculamos primeiramente os res√≠duos de Pearson e depois dividindo-o pela raiz quadrada do par√¢metro de dispers√£o, veja abaixo:

```{r}
EP <- resid(mod_quasipois, type = "pearson")
ED <- resid(mod_quasipois, type = "deviance")
mu <- predict(mod_quasipois, type = "response")
E <- fragmentos$Riqueza_obs - mu
EP2 <- E / sqrt(1.65662 * mu)#dispersion parameter da quasipoisson
op <- par(mfrow = c(2, 2))
plot(x = mu, y = E, main = "Response residuals")
plot(x = mu, y = EP, main = "Pearson residuals")
plot(x = mu, y = EP2, main = "Pearson residuals scaled")
plot(x = mu, y = ED, main = "Deviance residuals")
par(op)
par(mfrow=c(1,1))
```

Aqui vemos que n√£o existe um padr√£o claro nos res√≠duos, muito similar ao que t√≠nhamos anteriormente. Devido √†s limita√ß√µes de distribui√ß√µes "quasi" e dado que j√° temos um modelo adequado com binomial negativa, sugerimos interpretar apenas o modelo anterior com binomial negativa.

## Dados de contagem: a distribui√ß√£o Binomial

Quando temos dados de propor√ß√£o (e.g., n√∫mero de doentes por 1000 habitantes) ou incid√™ncia (i.e., presen√ßa ou aus√™ncia), a distribui√ß√£o mais adequada para modelar os dados √© a distribui√ß√£o binomial. No entanto, temos que especificar o modelo de acordo com o tipo dos dados no argumento `formula`. Vejamos dois exemplos:

### An√°lise com dados de propor√ß√£o

Neste exemplo vamos ver como podemos modelar a propor√ß√£o de c√©lulas sangu√≠neas em fun√ß√£o do tipo de tratamento.

**Explica√ß√£o dos dados**

Este conjunto de dados foi coletado por [@Franco-Belussi2018a]. Os autores utilizaram um desenho experimental t√≠pico de uma 2x5 ANOVA fatorial (ou two-way ANOVA) em que temos dois tratamentos (fatores): pigmenta√ß√£o do girino com dois n√≠veis (Yes e No) e Tempo de exposi√ß√£o com cinco n√≠veis (controle sem UV, 6 h, 12 h, 18 h e 24 h de exposi√ß√£o √† UV).

**Pergunta**

A melanina proteje girinos contra os efeitos da radia√ß√£o ultravioleta?

**Predi√ß√µes**

Como a melanina participa do sistema imune inato, ela desempenharia um papel na resposta do organismo √† radia√ß√£o UV, auxiliando as c√©lulas imunes a combater os seus efeitos delet√©rios.

**Vari√°veis**

‚Ä¢ Vari√°vel resposta: Contagem diferencial de eosin√≥filos

-- Dataframe com 10 girinos em cada tratamento, totalizando 50 girinos

```{r}
glimpse(uv_cells)
```

Vamos explorar os dados para tentar entender como s√£o as rela√ß√µes:

```{r}
lineplot.CI(UV, Eosinophil, Pigmentation, data=uv_cells)
```

Aqui vemos que a quantidade de eosin√≥filos √© muito maior nos girinos sem pigmenta√ß√£o ("albinos"). J√° que estes animais n√£o t√™m pigmenta√ß√£o mel√¢nica, as c√©lulas brancas do sangue s√£o a √∫nica ferramenta de combate aos efeitos delet√©rios da UV.

#### Modelagem

Aqui vamos usar o `cbind` no argumento `formula` para dizer que queremos modelar a contagem de eosin√≥filos *em rela√ß√£o ao n√∫mero total de c√©lulas, ou seja, sua propor√ß√£o.* Aqui temos a contagem do n√∫mero de eusin√≥filos (um tipo de c√©lula da s√©rie branca do sangue) em l√¢minas histol√≥gicas de girinos da r√£-touro (*Lithobates catesbeianus*) num total de 1000 c√©lulas:

```{r}
mod1<-glm(cbind(Eosinophil, Total_Cell)~UV*Pigmentation, family=binomial, data=uv_cells)
```

#### Diagnose b√°sica dos res√≠duos do modelo

```{r}
par(mfrow=c(2,2))
plot(mod1)
par(mfrow=c(1,1))
```

Parece que os res√≠duos n√£o sofrem de heterogeneidade de vari√¢ncia (linha vermelha est√° reta), mas parece haver um pequeno desvio da normalidade (veja pontos 19, 29 e 32 destacados no plot de quantis e no de outliers). Vejamos o que o `DHARMa` nos diz:

```{r}
simulationBion <- simulateResiduals(fittedModel = mod1, plot = TRUE)
binned_residuals(mod1)
```

Aqui j√° n√£o resta d√∫vidas de que os res√≠duos deste modelo sofrem tanto com heterogeneidade de vari√¢ncia, quanto *overdispersion* e problemas com outliers. Provavelmente o problema com outliers ocorreu por conta do pequeno tamanho amostral.

#### Infer√™ncia

Sabemos que o modelo n√£o parece ser adequado para os dados, mas vamos interpret√°-lo mesmo assim para que possamos entender o output do `summary` e os contrastes entre os n√≠veis dos fatores:

```{r}
summary(mod1)
anova(mod1)
```

Aqui temos tanto a tabela com os resultados por n√≠veis dos fatores (`summary`) quanto a tabela com a Deviance que mostra os fatores e suas intera√ß√µes (`anova`). Vemos que nenhum fator foi significativo. Caso houvesse algum fator significativo poder√≠amos testar a signific√¢ncia de cada n√≠vel dos fatores usando contrastes, desta forma:

```{r}
pairs(emmeans(mod1, ~ UV|Pigmentation))
```

Aqui temos o valor de cada combina√ß√£o de n√≠veis dos fatores, com seu respectivo valor de contraste e o valor de *P*. Vemos que para girinos sem pigmenta√ß√£o apenas 3 contrastes foram significativos.

##### Plot do modelo predito

```{r}
ggplot(uv_cells, aes(UV, Eosinophil)) +
geom_violin(aes(color=Pigmentation))+
  geom_jitter(shape = 16, position = position_jitter(0.1), cex = 4, alpha = 0.7)
```

Usando o `geom_violin` podemos perceber que existe uma dispers√£o maior nos tratamentos que utilizaram girinos sem pigmenta√ß√£o do que nos tratamentos com girinos pigmentados.

## An√°lise com dados de incid√™ncia

Uma outra aplica√ß√£o da distribui√ß√£o binomial √© quando temos dados de incid√™ncia, ou seja, presen√ßa ou aus√™ncia, de alguma vari√°vel. Por exemplo, presen√ßa ou aus√™ncia de uma esp√©cie ou indiv√≠duo num local. Neste caso a `formula` √© diferente e o modelo √© similar a uma regress√£o log√≠stica, vejamos.

Aqui vamos utilizar os dados sobre autotomia da cauda de lagartos da esp√©cie *Coleodactylus meridionalis* observados em fragmentos florestais da Mata Atl√¢ntica no estado de Pernambuco [@oliveira2020].

**Pergunta**

A probabilidade de lagartos da esp√©cie *Coleodactylus meridionalis* perderem (autotomizarem) a cauda aumenta com o tamanho do corpo e de acordo com o sexo dos lagarto?

**Predi√ß√µes**

Quanto maior o lagarto, maior a probabilidade de autotomia da cauda e que esta resposta poderia tamb√©m diferir entre sexos devido ao dimorfismo sexual.

**Vari√°veis**

‚Ä¢ Vari√°vel resposta: Presen√ßa ou aus√™ncia de cauda autotomizada em lagartos encontrados por busca ativa.

**Explora√ß√£o dos dados**

Este conjunto de dados possui muitas entradas faltantes (codificadas como `NA`). Primeiro vamos visualizar o conjunto de dados, e depois precisamos remover as linhas que cont√™m dados faltantes. Aqui podemos usar a fun√ß√£o interna do `ggplot2::remove_missing` para remover linhas cujas vari√°veis informadas no argumento estejam faltando, vejamos:

```{r}
head(lagartos)
vis_dat(lagartos)
vis_miss(lagartos,cluster = TRUE)#22.9% dos dados est√£o faltando
dados_semNA<-remove_missing(lagartos, vars = "Sex")#excluindo linhas com dados faltantes para a vari√°vel Sex
vis_miss(dados_semNA)
dim(dados_semNA)#verificar as dimens√µes da tabela depois que os dados tiverem sido exclu√≠dos
```

Agora, seguindo o que j√° estamos acostumados a fazer, vamos vizualisar os dados com a nossa hip√≥tese:

```{r}
ggplot(dados_semNA, aes(SVL, Tail_state))+
	geom_point(aes(shape=Sex, color=Sex), size = 4, alpha = 0.4)+
	geom_smooth(method = "glm", method.args=list(family="binomial"))+
  labs(y="Estado da Cauda", x="Comprimento Rostro-Cloacal (mm)")
```

#### Modelagem

Aqui vamos construir dois modelos com a mesma distribui√ß√£o binomial, mas com dois *link function*: logit e probit. A fun√ß√£o logit possui caudas um pouco mais achatadas, isto √©, a curva probit se aproxima dos eixos mais rapidamente que a logit. Geralmente n√£o h√° muita diferen√ßa entre elas. Como n√£o temos nenhuma expectativa de qual dos dois link function √© o melhor, podemos fazer uma sele√ß√£o de modelos:

```{r}
mod_log<-glm(Tail_state~SVL*Sex, data=dados_semNA, family = binomial(link="logit"))
mod_pro<-glm(Tail_state~SVL*Sex, data=dados_semNA, family = binomial(link="probit"))

AICctab(mod_log, mod_pro, nobs=139)
```

Existe pouca diferen√ßa entre o modelo probit e logit. Como o modelo logit √© mais simples vamos interpret√°-lo apenas.

#### Diagnose dos res√≠duos do modelo

```{r}
simulationBion <- simulateResiduals(fittedModel = mod_log, plot = T)
binned_residuals(mod_log)
```

#### Infer√™ncia

```{r}
anova(mod_log, test="Chisq" )
```

Para modelos com par√¢metro de dispers√£o conhecida (e.g., binomial e Poisson), o chi-quadrado √© a estat√≠stica mais apropriada.

#### Interpreta√ß√£o dos resultados

::: {.alert .alert-info}
<strong> üìù Importante </strong>\
A interpreta√ß√£o dos resultados √© que o tamanho de corpo (SVL) afeta negativamente a probabilidade da cauda estar intacta, i.e., com o aumento do tamanho, a probabilidade da cauda permanecer intacta diminui. A intera√ß√£o n√£o foi significativa, ent√£o o efeito √© independente do sexo dos lagartos.
:::

## Dados de contagem com excesso de zeros

Quando se analisa abund√¢ncia ou riqueza de esp√©cies √© comum que tenhamos dados com muitos zeros. Esse fen√¥meno pode ser causado por v√°rios processos ecol√≥gicos, tais como locais fora do nicho da esp√©cie, falha na detec√ß√£o, amostras feitas fora do h√°bitat ou em locais onde n√£o se espera encontrar a esp√©cie [@blascomoreno2019]. Esse tipo de dado √© problem√°tico porque rompe com os pressupostos da distribui√ß√£o Poisson e binomial negativa, podendo inclusive ser uma das causas da overdispersion.

Nesses casos, temos de ajustar modelos que levam em conta esse excesso de zeros nos dados. Esses modelos s√£o chamados de **zero-inflated** e **hurdle models** (tamb√©m chamados de zero-altered models), dependendo de como o processo que causou os zeros √© modelado.

Hurdle models (ou zero-altered models) modelam os dados dividindo-os em dois subconjuntos: um no qual reduzimos os dados √† presen√ßa-aus√™ncia, ou seja, todos os dados maiores que 1 s√£o transformados em 1 e usamos por exemplo uma distribui√ß√£o binomial; e uma outra parte que s√≥ considera os valores positivos sem zero, utilizando uma Poisson ou binomial negativa truncadas. Ao fazer isso, a distribui√ß√£o truncada assume que os zeros s√£o gerados tanto por processos ecol√≥gicos quanto erros de amostragem (ou seja, √© imposs√≠vel distinguir entre essas duas fontes). Portanto, esses zeros s√£o exclu√≠dos da distribui√ß√£o com dados de contagem. Por exemplo, se uma distribui√ß√£o binomial negativa for usada para modelar a parte quantitativa, chamamos o modelo de Zero-altered Negative Binomial. A interpreta√ß√£o dos modelos deve ser feita de forma conjunta.

Modelos com zero inflados funcionam de maneira similar, mas permitem que a distribui√ß√£o Poisson contenha zeros, ou seja, *n√£o √© utilizada uma distribui√ß√£o truncada*. Ao fazer isso, esta distribui√ß√£o de Poisson pressup√µe que os zeros foram gerados por um processo ecol√≥gico real, tal como, aus√™ncia de h√°bitat adequado.

Para ilustrar como podemos lidar com conjuntos de dados complexos vamos utilizar os dados do parasita *Raillietiella mottae* infectando duas esp√©cies de lagartos que ocorrem no nordeste Brasileiro [@lima2018]. Ao todo, 63 indiv√≠duos de *Hemidactylus agrius* e 132 de *Phyllopezus pollicaris* foram amostrados.

**Pergunta**

Quais atributos de hist√≥ria de vida dos lagartos s√£o relacionados com o volume (load) de infec√ß√£o, tais como tamanho e sexo?

**Predi√ß√µes**

Quanto maior o lagarto, maior o n√∫mero de parasitas encontrados, esta resposta poderia tamb√©m diferir entre sexos devido ao dimorfismo sexual.

**Vari√°veis**

‚Ä¢ Vari√°vel resposta: N√∫mero do parasita *Raillietiella mottae*, que √© um crust√°ceo parasita, infectando o aparelho respirat√≥rio e intestinal de lagartos. 

```{r}
head(parasitas)
```

Explorando os dados

```{r}
ggplot(parasitas, aes(Raillietiella_mottae))+
  geom_density(aes(fill="red"))+
  facet_grid(Especie~Sexo)+
  theme(legend.position = "none")

ggplot(parasitas, aes(CRC, Raillietiella_mottae)) +
geom_point(size = 4 , alpha = 0.4) +
facet_grid(Sexo~ Especie)
```

Os gr√°fico acima mostra a contagem do parasita *Raillietiella mottae* nos dois sexos (F e M para f√™mea e macho) nas duas esp√©cies de lagartos, tanto na forma de uma distribui√ß√£o de densidade quanto de gr√°fico de dispers√£o. Aqui podemos ver que de fato existe um excesso de zeros principalmente em *P. pollicaris*.

Quando nos deparamos com dados complexos assim, a estrat√©gia √© sempre come√ßar com um modelo simples e depois adicionar mais par√¢metros. Portanto, vamos iniciar com um modelo Poisson, mesmo sabendo que ele muito provavelmente n√£o ser√° adequado para modelar estes dados:

#### Modelagem

```{r}
pois_plain<-glm(Raillietiella_mottae~CRC+Sexo*Especie, data=parasitas, family="poisson")
```

#### Diagnose

Aqui vamos utilizar as fun√ß√µes do pacote `performance` novamente:

```{r}
check_zeroinflation(pois_plain)#para diagnosticar se o modelo sofre de zero inflation
check_overdispersion(pois_plain)
```

A diagnose n√£o s√≥ nos disse que o modelo possui overdispersion, como tamb√©m de zero-inflation, como j√° esper√°vamos. Vejamos ent√£o como melhorar o nosso modelo para lidar com esses dois problemas. Especificamente, vamos utilizar um modelo Hurdle com binomial negativa truncada (ou seja, desconsiderando os zeros), e um outro modelo zero-inflated usando uma distribui√ß√£o binomial negativa. 
Aqui vamos utilizar o pacote `glmmTMB` :

```{r}
hur_NB <- glmmTMB(Raillietiella_mottae~CRC+Sexo*Especie,  zi=~., data=parasitas, family=truncated_nbinom2)#Hurdle model
ziNB_mod2 <- glmmTMB(Raillietiella_mottae~CRC+Sexo*Especie,  zi=~., data=parasitas, family=nbinom2)#zero-inflated Poisson
ziP_mod2 <- glmmTMB(Raillietiella_mottae~CRC+Sexo*Especie,  zi=~., data=parasitas, family=poisson)#zero-inflated Negative Binomial
```

#### Diagnose

```{r}
check_zeroinflation(hur_NB)#prediz melhor os zeros
check_zeroinflation(ziP_mod2)
check_zeroinflation(ziNB_mod2)
```

Aqui vemos que o modelo zero-altered (Hurdle Model) conseguiu predizer exatamente a quantidade de zeros observada, fazendo com que o modelo seja suficiente para usarmos com esses dados.

```{r}
ICtab(pois_plain, hur_NB,ziP_mod2,ziNB_mod2, type=c("AICc"), weights = TRUE)
```

Mas quando comparamos o AICc entre modelos, os modelos zero-inflated (tanto Poisson, quanto binomial negativa) que tem menos par√¢metros, s√£o ranqueados ligeiramente melhor do que o modelo binomial negativa zero-altered (ou hurdle). N√£o podemos distinguir entre os dois modelos com zero-inflated porque o dAIC < 2, ou seja, o ajuste deles aos dados s√£o praticamente iguais. Vejam que a diferen√ßa de Akaike Weights entre os dois primeiros modelos e o hurdle √© bastante substancial (0.52). Al√©m disso, vemos que os modelos que levam em conta o excesso de zeros se ajustam bem melhor aos dados do que o modelo simples com distribui√ß√£o Poisson.
Vamos ver como os modelos se saem em rela√ß√£o aos outros pressupostos:

```{r}
simulationOutput <- simulateResiduals(fittedModel = hur_NB, plot = T)

simulationOutput <- simulateResiduals(fittedModel = ziNB_mod2, plot = T)#tem um outlier nos res√≠duos (asterisco vermelho)
```

Os gr√°ficos de diagnose do `DHARMa` s√£o outra evid√™ncia de que tanto o modelo hurdle quanto o zero-inflated Poisson s√£o adequados para os dados, em termos de heterogeneidade de vari√¢ncia, outliers e overdispersion.

#### Interpreta√ß√£o dos resultados

Apesar de n√£o ter um ajuste t√£o bom aos dados, o modelo hurdle prediz melhor a quantidade de zeros. Portanto, vamos interpretar os coeficientes apenas deste modelo: 

```{r}
summary(hur_NB)
```

Para maiores detalhes na interpreta√ß√£o deste tipo de modelo, sugerimos fortemente consultar p. 382-3 de Brooks et al. [-@brooks2017a]. Para fatores com mais de um n√≠vel, o `summary` mostra os resultados usando contraste, para isto toma como refer√™ncia um dos n√≠veis do fator (o primeiro em ordem alfab√©tica) e o compara com os outros.  Note que na parte com excesso de zeros o contraste √© positivo para Esp√©cie. Ou seja, o *P. pollicaris* tem maior chance de ter aus√™ncia de parasitas que *H. agrius*. O contraste para esp√©cie continua sendo positivo na parte condicional do modelo, mas o valor do par√¢metro n√£o √© t√£o alto. Isso quer dizer que *P. pollicaris* tem abund√¢ncia de parasitas em m√©dia ligeiramente maior que *H. agrius*. Vemos que a intera√ß√£o √© significativa entre sexo e esp√©cie na parte do modelo com excesso de zeros, mas apenas marginalmente significativa na parte condicional. Portanto, a influ√™ncia do sexo na incid√™ncia, mas n√£o na abund√¢ncia, do parasita depende conjuntamente da esp√©cie. No entanto, o CRC s√≥ passa a ser significativo na parte de excesso de zeros, ou seja, quando modelamos apenas a incid√™ncia (presen√ßa-aus√™ncia) do parasita. Portanto, o *CRC determina se o lagarto vai ou n√£o ser infectado, mas n√£o **o quanto** vai receber de parasitas*. J√° tanto o sexo quanto a esp√©cie foram significativas em ambas as partes do modelo, ou seja, esses fatores n√£o influenciam diferentemente a infec√ß√£o e a quantidade de parasitas.
Agora vejamos como podemos plotar as predi√ß√µes deste modelo:

```{r}
parasitas$phat <- predict(hur_NB, type="response")
parasitas <- parasitas[with(parasitas, order(Sexo, Especie)), ]
ggplot(parasitas, aes(x = CRC, y = phat, colour = Especie,shape = Sexo, 
									linetype = Sexo)) +
	geom_point(aes(y = Raillietiella_mottae), size=4, alpha=.7, position=position_jitter(h=.2)) +
	geom_line(size = 1) +
	labs(x = "Comprimento Rostro-Cloacal", y = expression(paste("Abund√¢ncia de ", italic("Raillietiella mottae"))))
```

## Dados ordinais: os modelos cumulative link

Uma outra maneira de codificarmos os dados √© utilizando categorias ordenadas, tais como ranques. Exemplos incluem a escala de Likert, scores, intervalos (e.g., de idade).

Para este exemplo, iremos utilizar um outro conjunto de dados do artigo de [@Franco-Belussi2018a] que manipulou *in vitro* a concentra√ß√£o do horm√¥nio noradrenalina (NA) nos olhos de peixes esgana-gato (*Gasterosteus aculeatus*) e avaliaram a express√£o de v√°rias cores conferidas por tipos de c√©lulas (cromat√≥foros). Aqui vamos usar os dados do efeito do NA na cor vermelha em machos.

**Pergunta**

A NA causa uma diminui√ß√£o da colora√ß√£o vermelha, via agrega√ß√£o dos pigmentos?

**Predi√ß√µes**

A presen√ßa de NA causa a agrega√ß√£o dos pigmentos, permitindo que os horm√¥nios reprodutivos atuem.

**Vari√°veis**

‚Ä¢ Vari√°vel resposta: Escala de intensidade de cor. Para mais detalhes veja o artigo original.

```{r}
cores <- read.csv2("https://ndownloader.figshare.com/files/10250700", h=TRUE)
head(cores)

## Filtrando dados - Red Male

redmale<- filter(cores, Sex=="M")
head(redmale)
```

Esses dados no entanto tem de ser codificados como um fator ordenado antes de entrarmos com eles no modelo.

```{r}
redmale$Animal<-factor(redmale$Animal)
redmale$Red<-factor(redmale$Red, levels = c("1", "2", "3", "4", "5"), ordered = TRUE)
str(redmale)
```

Repare que a classe do objeto muda e temos agora que Red √© um `Ordered factor`.

#### Modelagem

```{r}
mod3<-clmm(Red~Treatment+Time+(1|Animal), data=redmale, threshold = "equidistant")
```

#### Diagnose

Infelizmente, o pacote `ordinal` n√£o fornece m√©todos para lidar com modelos mistos, como o nosso. Ent√£o, montamos um modelo fixo apenas para entrar nas duas fun√ß√µes de diagnose. Essas duas fun√ß√µes `scale_test` e `nominal_test` testam a qualidade do ajuste (goodness-of-fit) do modelo, similar aos *likelihood ratio tests* s√≥ que para dados ordinais.

```{r}
assumption3 <- clm(Red~Treatment+Time, data=redmale, threshold = "equidistant")

scale_test(assumption3)
nominal_test(assumption3)
```

Parece que n√£o h√° problemas com o efeito de escala do dado ordinal, mas a diagnose sugere que possa haver evid√™ncia de rompimento do pressuposto de probabilidades proporcionais em rela√ß√£o ao tratamento. Esse √© um pressuposto importante de modelos ordinais, os quais assumem que os efeitos de qualquer uma das vari√°veis explicativas s√£o consistentes (proporcionais) ao longo de diferentes thresholds (que s√£o as quebras entre cada par de categorias da vari√°vel resposta ordinal).

Isto provavelmente se deve ao baixo tamanho amostral. Por quest√£o de brevidade vamos apenas ignorar este aspecto e interpretar o resultado do modelo mesmo assim. Mas se o seu modelo apresentar este problema, a solu√ß√£o deve ser realizar regress√µes log√≠sticas separadamente.

#### Infer√™ncia

```{r}
summary(mod3)
anova(assumption3)
pairs(emmeans(mod3, ~ Treatment|Time, adjust= "tukey"))
```

Aqui vemos que tanto o tratamento quanto o tempo de exposi√ß√£o foram significativos.

#### Interpreta√ß√£o dos resultados

```{r}
lineplot.CI(Time, as.numeric(Red), Treatment, data=redmale, cex = 1,
            xlab = "Experimental time (hours)", ylab = "Erythrophore Index (EI)", cex.lab = 1.5, x.leg = 1, y.leg = 1.2, cex.leg = 1.3, cex.axis = 1.5,
            col = c("#EE6363","#79CDCD"), pch = c(12,12), lwd = 1.5, ylim= c(0,5)) 
```

## Dados cont√≠nuos: distribui√ß√£o beta

Aqui vamos utilizar como exemplo os dados do artigo de [@Franco-Belussi2018a]. Os pesquisadores fizeram um experimento *in vivo* com peixes esgana-gato (*Gasterosteus aculeatus*) para testar como a colora√ß√£o dos animais respondem ao f√°rmaco ioimbina (YOH), que bloqueia a colora√ß√£o t√≠pica que os machos exibem na √©poca de acasalamento, e o tempo de exposi√ß√£o ao mesmo (al√©m de um controle), num desenho de ANOVA fatorial. Como as medidas foram feitas repetidamente no mesmo animal, iremos incluir o `Animal` como um fator aleat√≥rio no modelo.

**Pergunta**

A YOH aumenta a colora√ß√£o escura no olho e mand√≠bula dos peixes via dispers√£o dos pigmentos?

**Predi√ß√µes**

A YOH promover√° um escurecimento do corpo do animal, j√° que ela inibe a a√ß√£o NorAdrenalia (NA).

**Vari√°veis**

‚Ä¢ Vari√°vel resposta: A intensidade de colora√ß√£o escura em peixes machos. Esses dados s√£o expressos em termos de porcentagem e variam continuamente de 0 a 100%. Para facilitar a modelagem e nos adequarmos √† maneira com que a fun√ß√£o requer os dados, vamos simplesmente dividir por 100 para que os dados variem entre 0 e 1.

Para modelar os dados vamos utilizar a fun√ß√£o `glmmTMB`

```{r}
##Filtrando dados

fish$Animal<-factor(fish$Animal)
fish$Sex<-factor(fish$Sex)
darknessmale<- dplyr::filter(fish, Sex=="M")


ggplot(darknessmale, aes(Darkness/100)) +
  geom_density(colour="red", fill="red") +
  theme(legend.position="none")
```

No histograma podemos ver que os dados de fato variam continuamente no intervalo entre 0 e 1, tendo uma distribui√ß√£o notadamente bimodal.

#### Modelagem

```{r}
mod2<-glmmTMB(Darkness/100~Treatment*Time+(1|Animal), family= beta_family, data=darknessmale)
```

#### Diagnose

Aqui utilizaremos o mesmo pacote `DHARMa` para realizar a diagnose do modelo:

```{r}
simulationOutput <- simulateResiduals(fittedModel = mod2, plot = TRUE)
```

Podemos ver que o modelo n√£o sofre de heterogeneidade de dispers√£o, overdispersion, nem problemas com outlier.

#### Interpreta√ß√£o dos resultados

Agora que podemos interpretar o output com confian√ßa, vamos obter a tabela de anova em que teremos os testes de cada fator do modelo:

```{r}
Anova(mod2)
```

Aqui vemos que a intera√ß√£o √© significativa. Portanto, temos de interpretar os n√≠veis do fator da combina√ß√£o, fazemos isso no pacote `emmeans` colocando a barra \| :

```{r}
pairs(emmeans(mod2, ~ Treatment|Time))
```

Agora podemos perceber que a diferen√ßa entre o controle e o tratado s√≥ passa a ser significativa depois de 1 h de exposi√ß√£o.

Isso fica mais evidente quando plotamos os dados.

```{r}
lineplot.CI(Time, Darkness, Treatment, data=darknessmale, cex = 1, xlab = "Tempo experimental (horas)", ylab = "Escurid√£o do corpo de machos (%)", cex.lab = 1, x.leg = 1, col = c("#EE6363","#79CDCD"), pch = c(12,12), lwd = 1.5)
```

## Leituras recomendadas

Neste cap√≠tulo apenas fizemos uma breve introdu√ß√£o aos modelos lineares generalizados. Para conhecer um pouco mais a fundo todos os detalhes recomendamos a consulta dos livros [@zuur_protocol_2009] e [@pinheiro_mixed-effects_2000] que s√£o as refer√™ncias cl√°ssicas sobre GLM com aplica√ß√µes em ecologia. Para dados ordinais, sugerimos os livros do Alan Agresti, tais como [@agresti2010] e Categorical Data Analysis, 3rd Edition, do mesmo autor.
